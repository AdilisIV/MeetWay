{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"collection-compiled.js","sourcesContent":["\"use strict\";\n\nvar checkCollectionName = require('./utils').checkCollectionName\n  , ObjectID = require('mongodb-core').BSON.ObjectID\n  , Long = require('mongodb-core').BSON.Long\n  , Code = require('mongodb-core').BSON.Code\n  , f = require('util').format\n  , AggregationCursor = require('./aggregation_cursor')\n  , MongoError = require('mongodb-core').MongoError\n  , shallowClone = require('./utils').shallowClone\n  , isObject = require('./utils').isObject\n  , toError = require('./utils').toError\n  , normalizeHintField = require('./utils').normalizeHintField\n  , handleCallback = require('./utils').handleCallback\n  , decorateCommand = require('./utils').decorateCommand\n  , formattedOrderClause = require('./utils').formattedOrderClause\n  , ReadPreference = require('./read_preference')\n  , CoreReadPreference = require('mongodb-core').ReadPreference\n  , CommandCursor = require('./command_cursor')\n  , Define = require('./metadata')\n  , Cursor = require('./cursor')\n  , unordered = require('./bulk/unordered')\n  , ordered = require('./bulk/ordered')\n  , assign = require('./utils').assign\n  , mergeOptions = require('./utils').mergeOptions;\n\n/**\n * @fileOverview The **Collection** class is an internal class that embodies a MongoDB collection\n * allowing for insert/update/remove/find and other command operation on that MongoDB collection.\n *\n * **COLLECTION Cannot directly be instantiated**\n * @example\n * var MongoClient = require('mongodb').MongoClient,\n *   test = require('assert');\n * // Connection url\n * var url = 'mongodb://localhost:27017/test';\n * // Connect using MongoClient\n * MongoClient.connect(url, function(err, db) {\n *   // Create a collection we want to drop later\n *   var col = db.collection('createIndexExample1');\n *   // Show that duplicate records got dropped\n *   col.find({}).toArray(function(err, items) {\n *     test.equal(null, err);\n *     test.equal(4, items.length);\n *     db.close();\n *   });\n * });\n */\n\nvar mergeKeys = ['readPreference', 'ignoreUndefined'];\n\n/**\n * Create a new Collection instance (INTERNAL TYPE, do not instantiate directly)\n * @class\n * @property {string} collectionName Get the collection name.\n * @property {string} namespace Get the full collection namespace.\n * @property {object} writeConcern The current write concern values.\n * @property {object} readConcern The current read concern values.\n * @property {object} hint Get current index hint for collection.\n * @return {Collection} a Collection instance.\n */\nvar Collection = function(db, topology, dbName, name, pkFactory, options) {\n  checkCollectionName(name);\n\n  // Unpack variables\n  var internalHint = null;\n  var slaveOk = options == null || options.slaveOk == null ? db.slaveOk : options.slaveOk;\n  var serializeFunctions = options == null || options.serializeFunctions == null ? db.s.options.serializeFunctions : options.serializeFunctions;\n  var raw = options == null || options.raw == null ? db.s.options.raw : options.raw;\n  var promoteLongs = options == null || options.promoteLongs == null ? db.s.options.promoteLongs : options.promoteLongs;\n  var promoteValues = options == null || options.promoteValues == null ? db.s.options.promoteValues : options.promoteValues;\n  var promoteBuffers = options == null || options.promoteBuffers == null ? db.s.options.promoteBuffers : options.promoteBuffers;\n  var readPreference = null;\n  var collectionHint = null;\n  var namespace = f(\"%s.%s\", dbName, name);\n\n  // Get the promiseLibrary\n  var promiseLibrary = options.promiseLibrary;\n\n  // No promise library selected fall back\n  if(!promiseLibrary) {\n    promiseLibrary = typeof global.Promise == 'function' ?\n      global.Promise : require('es6-promise').Promise;\n  }\n\n  // Assign the right collection level readPreference\n  if(options && options.readPreference) {\n    readPreference = options.readPreference;\n  } else if(db.options.readPreference) {\n    readPreference = db.options.readPreference;\n  }\n\n  // Set custom primary key factory if provided\n  pkFactory = pkFactory == null\n    ? ObjectID\n    : pkFactory;\n\n  // Internal state\n  this.s = {\n    // Set custom primary key factory if provided\n      pkFactory: pkFactory\n    // Db\n    , db: db\n    // Topology\n    , topology: topology\n    // dbName\n    , dbName: dbName\n    // Options\n    , options: options\n    // Namespace\n    , namespace: namespace\n    // Read preference\n    , readPreference: readPreference\n    // SlaveOK\n    , slaveOk: slaveOk\n    // Serialize functions\n    , serializeFunctions: serializeFunctions\n    // Raw\n    , raw: raw\n    // promoteLongs\n    , promoteLongs: promoteLongs\n    // promoteValues\n    , promoteValues: promoteValues\n    // promoteBuffers\n    , promoteBuffers: promoteBuffers\n    // internalHint\n    , internalHint: internalHint\n    // collectionHint\n    , collectionHint: collectionHint\n    // Name\n    , name: name\n    // Promise library\n    , promiseLibrary: promiseLibrary\n    // Read Concern\n    , readConcern: options.readConcern\n  }\n}\n\nvar define = Collection.define = new Define('Collection', Collection, false);\n\nObject.defineProperty(Collection.prototype, 'collectionName', {\n  enumerable: true, get: function() { return this.s.name; }\n});\n\nObject.defineProperty(Collection.prototype, 'namespace', {\n  enumerable: true, get: function() { return this.s.namespace; }\n});\n\nObject.defineProperty(Collection.prototype, 'readConcern', {\n  enumerable: true, get: function() { return this.s.readConcern || {level: 'local'}; }\n});\n\nObject.defineProperty(Collection.prototype, 'writeConcern', {\n  enumerable:true,\n  get: function() {\n    var ops = {};\n    if(this.s.options.w != null) ops.w = this.s.options.w;\n    if(this.s.options.j != null) ops.j = this.s.options.j;\n    if(this.s.options.fsync != null) ops.fsync = this.s.options.fsync;\n    if(this.s.options.wtimeout != null) ops.wtimeout = this.s.options.wtimeout;\n    return ops;\n  }\n});\n\n/**\n * @ignore\n */\nObject.defineProperty(Collection.prototype, \"hint\", {\n    enumerable: true\n  , get: function () { return this.s.collectionHint; }\n  , set: function (v) { this.s.collectionHint = normalizeHintField(v); }\n});\n\n/**\n * Creates a cursor for a query that can be used to iterate over results from MongoDB\n * @method\n * @param {object} query The cursor query object.\n * @throws {MongoError}\n * @return {Cursor}\n */\nCollection.prototype.find = function() {\n  var options\n    , args = Array.prototype.slice.call(arguments, 0)\n    , has_callback = typeof args[args.length - 1] === 'function'\n    , has_weird_callback = typeof args[0] === 'function'\n    , callback = has_callback ? args.pop() : (has_weird_callback ? args.shift() : null)\n    , len = args.length\n    , selector = len >= 1 ? args[0] : {}\n    , fields = len >= 2 ? args[1] : undefined;\n\n  if(len === 1 && has_weird_callback) {\n    // backwards compat for callback?, options case\n    selector = {};\n    options = args[0];\n  }\n\n  if(len === 2 && fields !== undefined && !Array.isArray(fields)) {\n    var fieldKeys = Object.keys(fields);\n    var is_option = false;\n\n    for(var i = 0; i < fieldKeys.length; i++) {\n      if(testForFields[fieldKeys[i]] != null) {\n        is_option = true;\n        break;\n      }\n    }\n\n    if(is_option) {\n      options = fields;\n      fields = undefined;\n    } else {\n      options = {};\n    }\n  } else if(len === 2 && Array.isArray(fields) && !Array.isArray(fields[0])) {\n    var newFields = {};\n    // Rewrite the array\n    for(i = 0; i < fields.length; i++) {\n      newFields[fields[i]] = 1;\n    }\n    // Set the fields\n    fields = newFields;\n  }\n\n  if(3 === len) {\n    options = args[2];\n  }\n\n  // Ensure selector is not null\n  selector = selector == null ? {} : selector;\n  // Validate correctness off the selector\n  var object = selector;\n  if(Buffer.isBuffer(object)) {\n    var object_size = object[0] | object[1] << 8 | object[2] << 16 | object[3] << 24;\n    if(object_size != object.length)  {\n      var error = new Error(\"query selector raw message size does not match message header size [\" + object.length + \"] != [\" + object_size + \"]\");\n      error.name = 'MongoError';\n      throw error;\n    }\n  }\n\n  // Validate correctness of the field selector\n  object = fields;\n  if(Buffer.isBuffer(object)) {\n    object_size = object[0] | object[1] << 8 | object[2] << 16 | object[3] << 24;\n    if(object_size != object.length)  {\n      error = new Error(\"query fields raw message size does not match message header size [\" + object.length + \"] != [\" + object_size + \"]\");\n      error.name = 'MongoError';\n      throw error;\n    }\n  }\n\n  // Check special case where we are using an objectId\n  if(selector != null && selector._bsontype == 'ObjectID') {\n    selector = {_id:selector};\n  }\n\n  // If it's a serialized fields field we need to just let it through\n  // user be warned it better be good\n  if(options && options.fields && !(Buffer.isBuffer(options.fields))) {\n    fields = {};\n\n    if(Array.isArray(options.fields)) {\n      if(!options.fields.length) {\n        fields['_id'] = 1;\n      } else {\n        var l = options.fields.length;\n\n        for (i = 0; i < l; i++) {\n          fields[options.fields[i]] = 1;\n        }\n      }\n    } else {\n      fields = options.fields;\n    }\n  }\n\n  if (!options) options = {};\n\n  var newOptions = {};\n\n  // Make a shallow copy of the collection options\n  for(var key in this.s.options) {\n    if(mergeKeys.indexOf(key) != -1) {\n      newOptions[key] = this.s.options[key];\n    }\n  }\n\n  // Make a shallow copy of options\n  for (var key in options) {\n    newOptions[key] = options[key];\n  }\n\n  // Unpack options\n  newOptions.skip = len > 3 ? args[2] : options.skip ? options.skip : 0;\n  newOptions.limit = len > 3 ? args[3] : options.limit ? options.limit : 0;\n  newOptions.raw = options.raw != null && typeof options.raw === 'boolean' ? options.raw : this.s.raw;\n  newOptions.hint = options.hint != null ? normalizeHintField(options.hint) : this.s.collectionHint;\n  newOptions.timeout = len == 5 ? args[4] : typeof options.timeout === 'undefined' ? undefined : options.timeout;\n  // // If we have overridden slaveOk otherwise use the default db setting\n  newOptions.slaveOk = options.slaveOk != null ? options.slaveOk : this.s.db.slaveOk;\n\n  // Add read preference if needed\n  newOptions = getReadPreference(this, newOptions, this.s.db, this);\n\n  // Set slave ok to true if read preference different from primary\n  if(newOptions.readPreference != null\n    && (newOptions.readPreference != 'primary' || newOptions.readPreference.mode != 'primary')) {\n    newOptions.slaveOk = true;\n  }\n\n  // Ensure the query is an object\n  if(selector != null && typeof selector != 'object') {\n    throw MongoError.create({message: \"query selector must be an object\", driver:true });\n  }\n\n  // Build the find command\n  var findCommand = {\n      find: this.s.namespace\n    , limit: newOptions.limit\n    , skip: newOptions.skip\n    , query: selector\n  }\n\n  // Ensure we use the right await data option\n  if(typeof newOptions.awaitdata == 'boolean')  {\n    newOptions.awaitData = newOptions.awaitdata\n  }\n\n  // Translate to new command option noCursorTimeout\n  if(typeof newOptions.timeout == 'boolean') newOptions.noCursorTimeout = newOptions.timeout;\n\n  // Merge in options to command\n  for(var name in newOptions) {\n    if(newOptions[name] != null) findCommand[name] = newOptions[name];\n  }\n\n  // Format the fields\n  var formatFields = function(fields) {\n    var object = {};\n    if(Array.isArray(fields)) {\n      for(var i = 0; i < fields.length; i++) {\n        if(Array.isArray(fields[i])) {\n          object[fields[i][0]] = fields[i][1];\n        } else {\n          object[fields[i][0]] = 1;\n        }\n      }\n    } else {\n      object = fields;\n    }\n\n    return object;\n  }\n\n  // Special treatment for the fields selector\n  if(fields) findCommand.fields = formatFields(fields);\n\n  // Add db object to the new options\n  newOptions.db = this.s.db;\n\n  // Add the promise library\n  newOptions.promiseLibrary = this.s.promiseLibrary;\n\n  // Set raw if available at collection level\n  if(newOptions.raw == null && typeof this.s.raw == 'boolean') newOptions.raw = this.s.raw;\n  // Set promoteLongs if available at collection level\n  if(newOptions.promoteLongs == null && typeof this.s.promoteLongs == 'boolean') newOptions.promoteLongs = this.s.promoteLongs;\n  if(newOptions.promoteValues == null && typeof this.s.promoteValues == 'boolean') newOptions.promoteValues = this.s.promoteValues;\n  if(newOptions.promoteBuffers == null && typeof this.s.promoteBuffers == 'boolean') newOptions.promoteBuffers = this.s.promoteBuffers;\n\n  // Sort options\n  if(findCommand.sort) {\n    findCommand.sort = formattedOrderClause(findCommand.sort);\n  }\n\n  // Set the readConcern\n  if(this.s.readConcern) {\n    findCommand.readConcern = this.s.readConcern;\n  }\n\n  // Decorate find command with collation options\n  decorateWithCollation(findCommand, this, options);\n\n  // Create the cursor\n  if(typeof callback == 'function') return handleCallback(callback, null, this.s.topology.cursor(this.s.namespace, findCommand, newOptions));\n  return this.s.topology.cursor(this.s.namespace, findCommand, newOptions);\n}\n\ndefine.classMethod('find', {callback: false, promise:false, returns: [Cursor]});\n\n/**\n * Inserts a single document into MongoDB. If documents passed in do not contain the **_id** field,\n * one will be added to each of the documents missing it by the driver, mutating the document. This behavior\n * can be overridden by setting the **forceServerObjectId** flag.\n *\n * @method\n * @param {object} doc Document to insert.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.serializeFunctions=false] Serialize functions on any object.\n * @param {boolean} [options.forceServerObjectId=false] Force server to assign _id values instead of driver.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~insertOneWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.insertOne = function(doc, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n  if(Array.isArray(doc) && typeof callback == 'function') {\n    return callback(MongoError.create({message: 'doc parameter must be an object', driver:true }));\n  } else if(Array.isArray(doc)) {\n    return new this.s.promiseLibrary(function(resolve, reject) {\n      reject(MongoError.create({message: 'doc parameter must be an object', driver:true }));\n    });\n  }\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return insertOne(self, doc, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    insertOne(self, doc, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar insertOne = function(self, doc, options, callback) {\n  insertDocuments(self, [doc], options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    // Workaround for pre 2.6 servers\n    if(r == null) return callback(null, {result: {ok:1}});\n    // Add values to top level to ensure crud spec compatibility\n    r.insertedCount = r.result.n;\n    r.insertedId = doc._id;\n    if(callback) callback(null, r);\n  });\n}\n\nvar mapInserManyResults = function(docs, r) {\n  var ids = r.getInsertedIds();\n  var keys = Object.keys(ids);\n  var finalIds = new Array(keys.length);\n\n  for(var i = 0; i < keys.length; i++) {\n    if(ids[keys[i]]._id) {\n      finalIds[ids[keys[i]].index] = ids[keys[i]]._id;\n    }\n  }\n\n  var finalResult = {\n    result: {ok: 1, n: r.insertedCount},\n    ops: docs,\n    insertedCount: r.insertedCount,\n    insertedIds: finalIds\n  };\n\n  if(r.getLastOp()) {\n    finalResult.result.opTime = r.getLastOp();\n  }\n\n  return finalResult;\n}\n\ndefine.classMethod('insertOne', {callback: true, promise:true});\n\n/**\n * Inserts an array of documents into MongoDB. If documents passed in do not contain the **_id** field,\n * one will be added to each of the documents missing it by the driver, mutating the document. This behavior\n * can be overridden by setting the **forceServerObjectId** flag.\n *\n * @method\n * @param {object[]} docs Documents to insert.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.serializeFunctions=false] Serialize functions on any object.\n * @param {boolean} [options.forceServerObjectId=false] Force server to assign _id values instead of driver.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {boolean} [options.ordered=true] If true, when an insert fails, don't execute the remaining writes. If false, continue with remaining inserts when one fails.\n * @param {Collection~insertWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.insertMany = function(docs, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options ? shallowClone(options) : {ordered:true};\n  if(!Array.isArray(docs) && typeof callback == 'function') {\n    return callback(MongoError.create({message: 'docs parameter must be an array of documents', driver:true }));\n  } else if(!Array.isArray(docs)) {\n    return new this.s.promiseLibrary(function(resolve, reject) {\n      reject(MongoError.create({message: 'docs parameter must be an array of documents', driver:true }));\n    });\n  }\n\n  // Get the write concern options\n  if(typeof options.checkKeys != 'boolean') {\n    options.checkKeys = true;\n  }\n\n  // If keep going set unordered\n  options['serializeFunctions'] = options['serializeFunctions'] || self.s.serializeFunctions;\n\n  // Set up the force server object id\n  var forceServerObjectId = typeof options.forceServerObjectId == 'boolean'\n    ? options.forceServerObjectId : self.s.db.options.forceServerObjectId;\n\n  // Do we want to force the server to assign the _id key\n  if(forceServerObjectId !== true) {\n    // Add _id if not specified\n    for(var i = 0; i < docs.length; i++) {\n      if(docs[i]._id == null) docs[i]._id = self.s.pkFactory.createPk();\n    }\n  }\n\n  // Generate the bulk write operations\n  var operations = [{\n    insertMany: docs\n  }];\n\n  // Execute using callback\n  if(typeof callback == 'function') return bulkWrite(self, operations, options, function(err, r) {\n    if(err) return callback(err, r);\n    callback(null, mapInserManyResults(docs, r));\n  });\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    bulkWrite(self, operations, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(mapInserManyResults(docs, r));\n    });\n  });\n}\n\ndefine.classMethod('insertMany', {callback: true, promise:true});\n\n/**\n * @typedef {Object} Collection~BulkWriteOpResult\n * @property {number} insertedCount Number of documents inserted.\n * @property {number} matchedCount Number of documents matched for update.\n * @property {number} modifiedCount Number of documents modified.\n * @property {number} deletedCount Number of documents deleted.\n * @property {number} upsertedCount Number of documents upserted.\n * @property {object} insertedIds Inserted document generated Id's, hash key is the index of the originating operation\n * @property {object} upsertedIds Upserted document generated Id's, hash key is the index of the originating operation\n * @property {object} result The command result object.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~bulkWriteOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~BulkWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * Perform a bulkWrite operation without a fluent API\n *\n * Legal operation types are\n *\n *  { insertOne: { document: { a: 1 } } }\n *\n *  { updateOne: { filter: {a:2}, update: {$set: {a:2}}, upsert:true } }\n *\n *  { updateMany: { filter: {a:2}, update: {$set: {a:2}}, upsert:true } }\n *\n *  { deleteOne: { filter: {c:1} } }\n *\n *  { deleteMany: { filter: {c:1} } }\n *\n *  { replaceOne: { filter: {c:3}, replacement: {c:4}, upsert:true}}\n *\n * If documents passed in do not contain the **_id** field,\n * one will be added to each of the documents missing it by the driver, mutating the document. This behavior\n * can be overridden by setting the **forceServerObjectId** flag.\n *\n * @method\n * @param {object[]} operations Bulk operations to perform.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.serializeFunctions=false] Serialize functions on any object.\n * @param {boolean} [options.ordered=true] Execute write operation in ordered or unordered fashion.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~bulkWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.bulkWrite = function(operations, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {ordered:true};\n\n  if(!Array.isArray(operations)) {\n    throw MongoError.create({message: \"operations must be an array of documents\", driver:true });\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return bulkWrite(self, operations, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    bulkWrite(self, operations, options, function(err, r) {\n      if(err && r == null) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar bulkWrite = function(self, operations, options, callback) {\n  // Add ignoreUndfined\n  if(self.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = self.s.options.ignoreUndefined;\n  }\n\n  // Create the bulk operation\n  var bulk = options.ordered == true || options.ordered == null ? self.initializeOrderedBulkOp(options) : self.initializeUnorderedBulkOp(options);\n\n  // Do we have a collation\n  var collation = false;\n\n  // for each op go through and add to the bulk\n  try {\n    for(var i = 0; i < operations.length; i++) {\n      // Get the operation type\n      var key = Object.keys(operations[i])[0];\n      // Check if we have a collation\n      if(operations[i][key].collation) {\n        collation = true;\n      }\n\n      // Pass to the raw bulk\n      bulk.raw(operations[i]);\n    }\n  } catch(err) {\n    return callback(err, null);\n  }\n\n  // Final options for write concern\n  var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n  var writeCon = finalOptions.writeConcern ? finalOptions.writeConcern : {};\n  var capabilities = self.s.topology.capabilities();\n\n  // Did the user pass in a collation, check if our write server supports it\n  if(collation && capabilities && !capabilities.commandsTakeCollation) {\n    return callback(new MongoError(f('server/primary/mongos does not support collation')));\n  }\n\n  // Execute the bulk\n  bulk.execute(writeCon, function(err, r) {\n    // We have connection level error\n    if(!r && err) return callback(err, null);\n    // We have single error\n    if(r && r.hasWriteErrors() && r.getWriteErrorCount() == 1) {\n      return callback(toError(r.getWriteErrorAt(0)), r);\n    }\n\n    r.insertedCount = r.nInserted;\n    r.matchedCount = r.nMatched;\n    r.modifiedCount = r.nModified || 0;\n    r.deletedCount = r.nRemoved;\n    r.upsertedCount = r.getUpsertedIds().length;\n    r.upsertedIds = {};\n    r.insertedIds = {};\n\n    // Update the n\n    r.n = r.insertedCount;\n\n    // Inserted documents\n    var inserted = r.getInsertedIds();\n    // Map inserted ids\n    for(var i = 0; i < inserted.length; i++) {\n      r.insertedIds[inserted[i].index] = inserted[i]._id;\n    }\n\n    // Upserted documents\n    var upserted = r.getUpsertedIds();\n    // Map upserted ids\n    for(i = 0; i < upserted.length; i++) {\n      r.upsertedIds[upserted[i].index] = upserted[i]._id;\n    }\n\n    // Check if we have write errors\n    if(r.hasWriteErrors()) {\n      // Get all the errors\n      var errors = r.getWriteErrors();\n      // Return the MongoError object\n      return callback(toError({\n        message: 'write operation failed', code: errors[0].code, writeErrors: errors\n      }), r);\n    }\n\n    // Check if we have a writeConcern error\n    if(r.getWriteConcernError()) {\n      // Return the MongoError object\n      return callback(toError(r.getWriteConcernError()), r);\n    }\n\n    // Return the results\n    callback(null, r);\n  });\n}\n\nvar insertDocuments = function(self, docs, options, callback) {\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n  // Ensure we are operating on an array op docs\n  docs = Array.isArray(docs) ? docs : [docs];\n\n  // Get the write concern options\n  var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n  if(typeof finalOptions.checkKeys != 'boolean') finalOptions.checkKeys = true;\n\n  // If keep going set unordered\n  if(finalOptions.keepGoing == true) finalOptions.ordered = false;\n  finalOptions['serializeFunctions'] = options['serializeFunctions'] || self.s.serializeFunctions;\n\n  // Set up the force server object id\n  var forceServerObjectId = typeof options.forceServerObjectId == 'boolean'\n    ? options.forceServerObjectId : self.s.db.options.forceServerObjectId;\n\n  // Add _id if not specified\n  if(forceServerObjectId !== true){\n    for(var i = 0; i < docs.length; i++) {\n      if(docs[i]._id === void 0) docs[i]._id = self.s.pkFactory.createPk();\n    }\n  }\n\n  // File inserts\n  self.s.topology.insert(self.s.namespace, docs, finalOptions, function(err, result) {\n    if(callback == null) return;\n    if(err) return handleCallback(callback, err);\n    if(result == null) return handleCallback(callback, null, null);\n    if(result.result.code) return handleCallback(callback, toError(result.result));\n    if(result.result.writeErrors) return handleCallback(callback, toError(result.result.writeErrors[0]));\n    // Add docs to the list\n    result.ops = docs;\n    // Return the results\n    handleCallback(callback, null, result);\n  });\n}\n\ndefine.classMethod('bulkWrite', {callback: true, promise:true});\n\n/**\n * @typedef {Object} Collection~WriteOpResult\n * @property {object[]} ops All the documents inserted using insertOne/insertMany/replaceOne. Documents contain the _id field if forceServerObjectId == false for insertOne/insertMany\n * @property {object} connection The connection object used for the operation.\n * @property {object} result The command result object.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~writeOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~WriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * @typedef {Object} Collection~insertWriteOpResult\n * @property {Number} insertedCount The total amount of documents inserted.\n * @property {object[]} ops All the documents inserted using insertOne/insertMany/replaceOne. Documents contain the _id field if forceServerObjectId == false for insertOne/insertMany\n * @property {ObjectId[]} insertedIds All the generated _id's for the inserted documents.\n * @property {object} connection The connection object used for the operation.\n * @property {object} result The raw command result object returned from MongoDB (content might vary by server version).\n * @property {Number} result.ok Is 1 if the command executed correctly.\n * @property {Number} result.n The total count of documents inserted.\n */\n\n/**\n * @typedef {Object} Collection~insertOneWriteOpResult\n * @property {Number} insertedCount The total amount of documents inserted.\n * @property {object[]} ops All the documents inserted using insertOne/insertMany/replaceOne. Documents contain the _id field if forceServerObjectId == false for insertOne/insertMany\n * @property {ObjectId} insertedId The driver generated ObjectId for the insert operation.\n * @property {object} connection The connection object used for the operation.\n * @property {object} result The raw command result object returned from MongoDB (content might vary by server version).\n * @property {Number} result.ok Is 1 if the command executed correctly.\n * @property {Number} result.n The total count of documents inserted.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~insertWriteOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~insertWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~insertOneWriteOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~insertOneWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * Inserts a single document or a an array of documents into MongoDB. If documents passed in do not contain the **_id** field,\n * one will be added to each of the documents missing it by the driver, mutating the document. This behavior\n * can be overridden by setting the **forceServerObjectId** flag.\n *\n * @method\n * @param {(object|object[])} docs Documents to insert.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.serializeFunctions=false] Serialize functions on any object.\n * @param {boolean} [options.forceServerObjectId=false] Force server to assign _id values instead of driver.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~insertWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated Use insertOne, insertMany or bulkWrite\n */\nCollection.prototype.insert = function(docs, options, callback) {\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {ordered:false};\n  docs = !Array.isArray(docs) ? [docs] : docs;\n\n  if(options.keepGoing == true) {\n    options.ordered = false;\n  }\n\n  return this.insertMany(docs, options, callback);\n}\n\ndefine.classMethod('insert', {callback: true, promise:true});\n\n/**\n * @typedef {Object} Collection~updateWriteOpResult\n * @property {Object} result The raw result returned from MongoDB, field will vary depending on server version.\n * @property {Number} result.ok Is 1 if the command executed correctly.\n * @property {Number} result.n The total count of documents scanned.\n * @property {Number} result.nModified The total count of documents modified.\n * @property {Object} connection The connection object used for the operation.\n * @property {Number} matchedCount The number of documents that matched the filter.\n * @property {Number} modifiedCount The number of documents that were modified.\n * @property {Number} upsertedCount The number of documents upserted.\n * @property {Object} upsertedId The upserted id.\n * @property {ObjectId} upsertedId._id The upserted _id returned from the server.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~updateWriteOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~updateWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * Update a single document on MongoDB\n * @method\n * @param {object} filter The Filter used to select the document to update\n * @param {object} update The update operations to be applied to the document\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.upsert=false] Update operation is an upsert.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~updateWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.updateOne = function(filter, update, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = shallowClone(options)\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return updateOne(self, filter, update, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    updateOne(self, filter, update, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar updateOne = function(self, filter, update, options, callback) {\n  // Set single document update\n  options.multi = false;\n  // Execute update\n  updateDocuments(self, filter, update, options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    if(r == null) return callback(null, {result: {ok:1}});\n    r.modifiedCount = r.result.nModified != null ? r.result.nModified : r.result.n;\n    r.upsertedId = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? r.result.upserted[0] : null;\n    r.upsertedCount = Array.isArray(r.result.upserted) && r.result.upserted.length ? r.result.upserted.length : 0;\n    r.matchedCount = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? 0 : r.result.n;\n    if(callback) callback(null, r);\n  });\n}\n\ndefine.classMethod('updateOne', {callback: true, promise:true});\n\n/**\n * Replace a document on MongoDB\n * @method\n * @param {object} filter The Filter used to select the document to update\n * @param {object} doc The Document that replaces the matching document\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.upsert=false] Update operation is an upsert.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~updateWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.replaceOne = function(filter, doc, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = shallowClone(options)\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return replaceOne(self, filter, doc, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    replaceOne(self, filter, doc, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar replaceOne = function(self, filter, doc, options, callback) {\n  // Set single document update\n  options.multi = false;\n\n  // Execute update\n  updateDocuments(self, filter, doc, options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    if(r == null) return callback(null, {result: {ok:1}});\n\n    r.modifiedCount = r.result.nModified != null ? r.result.nModified : r.result.n;\n    r.upsertedId = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? r.result.upserted[0] : null;\n    r.upsertedCount = Array.isArray(r.result.upserted) && r.result.upserted.length ? r.result.upserted.length : 0;\n    r.matchedCount = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? 0 : r.result.n;\n    r.ops = [doc];\n    if(callback) callback(null, r);\n  });\n}\n\ndefine.classMethod('replaceOne', {callback: true, promise:true});\n\n/**\n * Update multiple documents on MongoDB\n * @method\n * @param {object} filter The Filter used to select the document to update\n * @param {object} update The update operations to be applied to the document\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.upsert=false] Update operation is an upsert.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~updateWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.updateMany = function(filter, update, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = shallowClone(options)\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return updateMany(self, filter, update, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    updateMany(self, filter, update, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar updateMany = function(self, filter, update, options, callback) {\n  // Set single document update\n  options.multi = true;\n  // Execute update\n  updateDocuments(self, filter, update, options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    if(r == null) return callback(null, {result: {ok:1}});\n    r.modifiedCount = r.result.nModified != null ? r.result.nModified : r.result.n;\n    r.upsertedId = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? r.result.upserted[0] : null;\n    r.upsertedCount = Array.isArray(r.result.upserted) && r.result.upserted.length ? r.result.upserted.length : 0;\n    r.matchedCount = Array.isArray(r.result.upserted) && r.result.upserted.length > 0 ? 0 : r.result.n;\n    if(callback) callback(null, r);\n  });\n}\n\ndefine.classMethod('updateMany', {callback: true, promise:true});\n\nvar updateDocuments = function(self, selector, document, options, callback) {\n  if('function' === typeof options) callback = options, options = null;\n  if(options == null) options = {};\n  if(!('function' === typeof callback)) callback = null;\n\n  // If we are not providing a selector or document throw\n  if(selector == null || typeof selector != 'object') return callback(toError(\"selector must be a valid JavaScript object\"));\n  if(document == null || typeof document != 'object') return callback(toError(\"document must be a valid JavaScript object\"));\n\n  // Get the write concern options\n  var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n\n  // Do we return the actual result document\n  // Either use override on the function, or go back to default on either the collection\n  // level or db\n  finalOptions['serializeFunctions'] = options['serializeFunctions'] || self.s.serializeFunctions;\n\n  // Execute the operation\n  var op = {q: selector, u: document};\n  op.upsert = typeof options.upsert == 'boolean' ? options.upsert : false;\n  op.multi = typeof options.multi == 'boolean' ? options.multi : false;\n\n  // Have we specified collation\n  decorateWithCollation(finalOptions, self, options);\n\n  // Update options\n  self.s.topology.update(self.s.namespace, [op], finalOptions, function(err, result) {\n    if(callback == null) return;\n    if(err) return handleCallback(callback, err, null);\n    if(result == null) return handleCallback(callback, null, null);\n    if(result.result.code) return handleCallback(callback, toError(result.result));\n    if(result.result.writeErrors) return handleCallback(callback, toError(result.result.writeErrors[0]));\n    // Return the results\n    handleCallback(callback, null, result);\n  });\n}\n\n/**\n * Updates documents.\n * @method\n * @param {object} selector The selector for the update operation.\n * @param {object} document The update document.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.upsert=false] Update operation is an upsert.\n * @param {boolean} [options.multi=false] Update one/all documents with operation.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {object} [options.collation=null] Specify collation (MongoDB 3.4 or higher) settings for update operation (see 3.4 documentation for available fields).\n * @param {Collection~writeOpCallback} [callback] The command result callback\n * @throws {MongoError}\n * @return {Promise} returns Promise if no callback passed\n * @deprecated use updateOne, updateMany or bulkWrite\n */\nCollection.prototype.update = function(selector, document, options, callback) {\n  var self = this;\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return updateDocuments(self, selector, document, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    updateDocuments(self, selector, document, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\ndefine.classMethod('update', {callback: true, promise:true});\n\n/**\n * @typedef {Object} Collection~deleteWriteOpResult\n * @property {Object} result The raw result returned from MongoDB, field will vary depending on server version.\n * @property {Number} result.ok Is 1 if the command executed correctly.\n * @property {Number} result.n The total count of documents deleted.\n * @property {Object} connection The connection object used for the operation.\n * @property {Number} deletedCount The number of documents deleted.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~deleteWriteOpCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~deleteWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * Delete a document on MongoDB\n * @method\n * @param {object} filter The Filter used to select the document to remove\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~deleteWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.deleteOne = function(filter, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = shallowClone(options);\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return deleteOne(self, filter, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    deleteOne(self, filter, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar deleteOne = function(self, filter, options, callback) {\n  options.single = true;\n  removeDocuments(self, filter, options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    if(r == null) return callback(null, {result: {ok:1}});\n    r.deletedCount = r.result.n;\n    if(callback) callback(null, r);\n  });\n}\n\ndefine.classMethod('deleteOne', {callback: true, promise:true});\n\nCollection.prototype.removeOne = Collection.prototype.deleteOne;\n\ndefine.classMethod('removeOne', {callback: true, promise:true});\n\n/**\n * Delete multiple documents on MongoDB\n * @method\n * @param {object} filter The Filter used to select the documents to remove\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~deleteWriteOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.deleteMany = function(filter, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = shallowClone(options);\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return deleteMany(self, filter, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    deleteMany(self, filter, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar deleteMany = function(self, filter, options, callback) {\n  options.single = false;\n\n  removeDocuments(self, filter, options, function(err, r) {\n    if(callback == null) return;\n    if(err && callback) return callback(err);\n    if(r == null) return callback(null, {result: {ok:1}});\n    r.deletedCount = r.result.n;\n    if(callback) callback(null, r);\n  });\n}\n\nvar removeDocuments = function(self, selector, options, callback) {\n  if(typeof options == 'function') {\n    callback = options, options = {};\n  } else if (typeof selector === 'function') {\n    callback = selector;\n    options = {};\n    selector = {};\n  }\n\n  // Create an empty options object if the provided one is null\n  options = options || {};\n\n  // Get the write concern options\n  var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n\n  // If selector is null set empty\n  if(selector == null) selector = {};\n\n  // Build the op\n  var op = {q: selector, limit: 0};\n  if(options.single) op.limit = 1;\n\n  // Have we specified collation\n  decorateWithCollation(finalOptions, self, options);\n\n  // Execute the remove\n  self.s.topology.remove(self.s.namespace, [op], finalOptions, function(err, result) {\n    if(callback == null) return;\n    if(err) return handleCallback(callback, err, null);\n    if(result == null) return handleCallback(callback, null, null);\n    if(result.result.code) return handleCallback(callback, toError(result.result));\n    if(result.result.writeErrors) return handleCallback(callback, toError(result.result.writeErrors[0]));\n    // Return the results\n    handleCallback(callback, null, result);\n  });\n}\n\ndefine.classMethod('deleteMany', {callback: true, promise:true});\n\nCollection.prototype.removeMany = Collection.prototype.deleteMany;\n\ndefine.classMethod('removeMany', {callback: true, promise:true});\n\n/**\n * Remove documents.\n * @method\n * @param {object} selector The selector for the update operation.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.single=false] Removes the first document found.\n * @param {Collection~writeOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated use deleteOne, deleteMany or bulkWrite\n */\nCollection.prototype.remove = function(selector, options, callback) {\n  var self = this;\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return removeDocuments(self, selector, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    removeDocuments(self, selector, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\ndefine.classMethod('remove', {callback: true, promise:true});\n\n/**\n * Save a document. Simple full document replacement function. Not recommended for efficiency, use atomic\n * operators and update instead for more efficient operations.\n * @method\n * @param {object} doc Document to save\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~writeOpCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated use insertOne, insertMany, updateOne or updateMany\n */\nCollection.prototype.save = function(doc, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Add ignoreUndfined\n  if(this.s.options.ignoreUndefined) {\n    options = shallowClone(options);\n    options.ignoreUndefined = this.s.options.ignoreUndefined;\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return save(self, doc, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    save(self, doc, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar save = function(self, doc, options, callback) {\n  // Get the write concern options\n  var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n  // Establish if we need to perform an insert or update\n  if(doc._id != null) {\n    finalOptions.upsert = true;\n    return updateDocuments(self, {_id: doc._id}, doc, finalOptions, callback);\n  }\n\n  // Insert the document\n  insertDocuments(self, [doc], options, function(err, r) {\n    if(callback == null) return;\n    if(doc == null) return handleCallback(callback, null, null);\n    if(err) return handleCallback(callback, err, null);\n    handleCallback(callback, null, r);\n  });\n}\n\ndefine.classMethod('save', {callback: true, promise:true});\n\n/**\n * The callback format for results\n * @callback Collection~resultCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {object} result The result object if the command was executed successfully.\n */\n\n/**\n * Fetches the first document that matches the query\n * @method\n * @param {object} query Query for find Operation\n * @param {object} [options=null] Optional settings.\n * @param {number} [options.limit=0] Sets the limit of documents returned in the query.\n * @param {(array|object)} [options.sort=null] Set to sort the documents coming back from the query. Array of indexes, [['a', 1]] etc.\n * @param {object} [options.fields=null] The fields to return in the query. Object of fields to include or exclude (not both), {'a':1}\n * @param {number} [options.skip=0] Set to skip N documents ahead in your query (useful for pagination).\n * @param {Object} [options.hint=null] Tell the query to use specific indexes in the query. Object of indexes to use, {'_id':1}\n * @param {boolean} [options.explain=false] Explain the query instead of returning the data.\n * @param {boolean} [options.snapshot=false] Snapshot query.\n * @param {boolean} [options.timeout=false] Specify if the cursor can timeout.\n * @param {boolean} [options.tailable=false] Specify if the cursor is tailable.\n * @param {number} [options.batchSize=0] Set the batchSize for the getMoreCommand when iterating over the query results.\n * @param {boolean} [options.returnKey=false] Only return the index key.\n * @param {number} [options.maxScan=null] Limit the number of items to scan.\n * @param {number} [options.min=null] Set index bounds.\n * @param {number} [options.max=null] Set index bounds.\n * @param {boolean} [options.showDiskLoc=false] Show disk location of results.\n * @param {string} [options.comment=null] You can put a $comment field on a query to make looking in the profiler logs simpler.\n * @param {boolean} [options.raw=false] Return document results as raw BSON buffers.\n * @param {boolean} [options.promoteLongs=true] Promotes Long values to number if they fit inside the 53 bits resolution.\n * @param {boolean} [options.promoteValues=true] Promotes BSON values to native types where possible, set to false to only receive wrapper types.\n * @param {boolean} [options.promoteBuffers=false] Promotes Binary BSON values to native Node Buffers.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {boolean} [options.partial=false] Specify if the cursor should return partial results when querying against a sharded system\n * @param {number} [options.maxTimeMS=null] Number of miliseconds to wait before aborting the query.\n * @param {object} [options.collation=null] Specify collation (MongoDB 3.4 or higher) settings for update operation (see 3.4 documentation for available fields).\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.findOne = function() {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 0);\n  var callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n\n  // Execute using callback\n  if(typeof callback == 'function') return findOne(self, args, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    findOne(self, args, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findOne = function(self, args, callback) {\n  var cursor = self.find.apply(self, args).limit(-1).batchSize(1);\n  // Return the item\n  cursor.next(function(err, item) {\n    if(err != null) return handleCallback(callback, toError(err), null);\n    handleCallback(callback, null, item);\n  });\n}\n\ndefine.classMethod('findOne', {callback: true, promise:true});\n\n/**\n * The callback format for the collection method, must be used if strict is specified\n * @callback Collection~collectionResultCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection} collection The collection instance.\n */\n\n/**\n * Rename the collection.\n *\n * @method\n * @param {string} newName New name of of the collection.\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.dropTarget=false] Drop the target name collection if it previously exists.\n * @param {Collection~collectionResultCallback} [callback] The results callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.rename = function(newName, opt, callback) {\n  var self = this;\n  if(typeof opt == 'function') callback = opt, opt = {};\n  opt = assign({}, opt, {readPreference: ReadPreference.PRIMARY});\n\n  // Execute using callback\n  if(typeof callback == 'function') return rename(self, newName, opt, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    rename(self, newName, opt, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar rename = function(self, newName, opt, callback) {\n  // Check the collection name\n  checkCollectionName(newName);\n  // Build the command\n  var renameCollection = f(\"%s.%s\", self.s.dbName, self.s.name);\n  var toCollection =  f(\"%s.%s\", self.s.dbName, newName);\n  var dropTarget = typeof opt.dropTarget == 'boolean' ? opt.dropTarget : false;\n  var cmd = {'renameCollection':renameCollection, 'to':toCollection, 'dropTarget':dropTarget};\n\n  // Decorate command with writeConcern if supported\n  decorateWithWriteConcern(cmd, self, opt);\n\n  // Execute against admin\n  self.s.db.admin().command(cmd, opt, function(err, doc) {\n    if(err) return handleCallback(callback, err, null);\n    // We have an error\n    if(doc.errmsg) return handleCallback(callback, toError(doc), null);\n    try {\n      return handleCallback(callback, null, new Collection(self.s.db, self.s.topology, self.s.dbName, newName, self.s.pkFactory, self.s.options));\n    } catch(err) {\n      return handleCallback(callback, toError(err), null);\n    }\n  });\n}\n\ndefine.classMethod('rename', {callback: true, promise:true});\n\n/**\n * Drop the collection from the database, removing it permanently. New accesses will create a new collection.\n *\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {Collection~resultCallback} [callback] The results callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.drop = function(options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return self.s.db.dropCollection(self.s.name, options, callback);\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    self.s.db.dropCollection(self.s.name, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\ndefine.classMethod('drop', {callback: true, promise:true});\n\n/**\n * Returns the options of the collection.\n *\n * @method\n * @param {Collection~resultCallback} [callback] The results callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.options = function(callback) {\n  var self = this;\n\n  // Execute using callback\n  if(typeof callback == 'function') return options(self, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    options(self, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar options = function(self, callback) {\n  self.s.db.listCollections({name: self.s.name}).toArray(function(err, collections) {\n    if(err) return handleCallback(callback, err);\n    if(collections.length == 0) {\n      return handleCallback(callback, MongoError.create({message: f(\"collection %s not found\", self.s.namespace), driver:true }));\n    }\n\n    handleCallback(callback, err, collections[0].options || null);\n  });\n}\n\ndefine.classMethod('options', {callback: true, promise:true});\n\n/**\n * Returns if the collection is a capped collection\n *\n * @method\n * @param {Collection~resultCallback} [callback] The results callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.isCapped = function(callback) {\n  var self = this;\n\n  // Execute using callback\n  if(typeof callback == 'function') return isCapped(self, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    isCapped(self, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar isCapped = function(self, callback) {\n  self.options(function(err, document) {\n    if(err) return handleCallback(callback, err);\n    handleCallback(callback, null, document && document.capped);\n  });\n}\n\ndefine.classMethod('isCapped', {callback: true, promise:true});\n\n/**\n * Creates an index on the db and collection collection.\n * @method\n * @param {(string|object)} fieldOrSpec Defines the index.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.unique=false] Creates an unique index.\n * @param {boolean} [options.sparse=false] Creates a sparse index.\n * @param {boolean} [options.background=false] Creates the index in the background, yielding whenever possible.\n * @param {boolean} [options.dropDups=false] A unique index cannot be created on a key that has pre-existing duplicate values. If you would like to create the index anyway, keeping the first document the database indexes and deleting all subsequent documents that have duplicate value\n * @param {number} [options.min=null] For geospatial indexes set the lower bound for the co-ordinates.\n * @param {number} [options.max=null] For geospatial indexes set the high bound for the co-ordinates.\n * @param {number} [options.v=null] Specify the format version of the indexes.\n * @param {number} [options.expireAfterSeconds=null] Allows you to expire data on indexes applied to a data (MongoDB 2.2 or higher)\n * @param {string} [options.name=null] Override the autogenerated index name (useful if the resulting name is larger than 128 bytes)\n * @param {object} [options.partialFilterExpression=null] Creates a partial index based on the given filter object (MongoDB 3.2 or higher)\n * @param {object} [options.collation=null] Specify collation (MongoDB 3.4 or higher) settings for update operation (see 3.4 documentation for available fields).\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.createIndex = function(fieldOrSpec, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 1);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  options = args.length ? args.shift() || {} : {};\n  options = typeof callback === 'function' ? options : callback;\n  options = options == null ? {} : options;\n\n  // Execute using callback\n  if(typeof callback == 'function') return createIndex(self, fieldOrSpec, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    createIndex(self, fieldOrSpec, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar createIndex = function(self, fieldOrSpec, options, callback) {\n  self.s.db.createIndex(self.s.name, fieldOrSpec, options, callback);\n}\n\ndefine.classMethod('createIndex', {callback: true, promise:true});\n\n/**\n * Creates multiple indexes in the collection, this method is only supported for\n * MongoDB 2.6 or higher. Earlier version of MongoDB will throw a command not supported\n * error. Index specifications are defined at http://docs.mongodb.org/manual/reference/command/createIndexes/.\n * @method\n * @param {array} indexSpecs An array of index specifications to be created\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.createIndexes = function(indexSpecs, callback) {\n  var self = this;\n\n  // Execute using callback\n  if(typeof callback == 'function') return createIndexes(self, indexSpecs, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    createIndexes(self, indexSpecs, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar createIndexes = function(self, indexSpecs, callback) {\n  var capabilities = self.s.topology.capabilities();\n\n  // Ensure we generate the correct name if the parameter is not set\n  for(var i = 0; i < indexSpecs.length; i++) {\n    if(indexSpecs[i].name == null) {\n      var keys = [];\n\n      // Did the user pass in a collation, check if our write server supports it\n      if(indexSpecs[i].collation && capabilities && !capabilities.commandsTakeCollation) {\n        return callback(new MongoError(f('server/primary/mongos does not support collation')));\n      }\n\n      for(var name in indexSpecs[i].key) {\n        keys.push(f('%s_%s', name, indexSpecs[i].key[name]));\n      }\n\n      // Set the name\n      indexSpecs[i].name = keys.join('_');\n    }\n  }\n\n  // Execute the index\n  self.s.db.command({\n    createIndexes: self.s.name, indexes: indexSpecs\n  }, { readPreference: ReadPreference.PRIMARY }, callback);\n}\n\ndefine.classMethod('createIndexes', {callback: true, promise:true});\n\n/**\n * Drops an index from this collection.\n * @method\n * @param {string} indexName Name of the index to drop.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.dropIndex = function(indexName, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 1);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  options = args.length ? args.shift() || {} : {};\n  // Run only against primary\n  options.readPreference = ReadPreference.PRIMARY;\n\n  // Execute using callback\n  if(typeof callback == 'function') return dropIndex(self, indexName, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    dropIndex(self, indexName, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar dropIndex = function(self, indexName, options, callback) {\n  // Delete index command\n  var cmd = {'dropIndexes':self.s.name, 'index':indexName};\n\n  // Decorate command with writeConcern if supported\n  decorateWithWriteConcern(cmd, self, options);\n\n  // Execute command\n  self.s.db.command(cmd, options, function(err, result) {\n    if(typeof callback != 'function') return;\n    if(err) return handleCallback(callback, err, null);\n    handleCallback(callback, null, result);\n  });\n}\n\ndefine.classMethod('dropIndex', {callback: true, promise:true});\n\n/**\n * Drops all indexes from this collection.\n * @method\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.dropIndexes = function(options, callback) {\n  var self = this;\n\n  // Do we have options\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return dropIndexes(self, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    dropIndexes(self, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar dropIndexes = function(self, options, callback) {\n  self.dropIndex('*', options, function(err) {\n    if(err) return handleCallback(callback, err, false);\n    handleCallback(callback, null, true);\n  });\n}\n\ndefine.classMethod('dropIndexes', {callback: true, promise:true});\n\n/**\n * Drops all indexes from this collection.\n * @method\n * @deprecated use dropIndexes\n * @param {Collection~resultCallback} callback The command result callback\n * @return {Promise} returns Promise if no [callback] passed\n */\nCollection.prototype.dropAllIndexes = Collection.prototype.dropIndexes;\n\ndefine.classMethod('dropAllIndexes', {callback: true, promise:true});\n\n/**\n * Reindex all indexes on the collection\n * Warning: reIndex is a blocking operation (indexes are rebuilt in the foreground) and will be slow for large collections.\n * @method\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.reIndex = function(options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return reIndex(self, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    reIndex(self, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar reIndex = function(self, options, callback) {\n  // Reindex\n  var cmd = {'reIndex':self.s.name};\n\n  // Execute the command\n  self.s.db.command(cmd, options, function(err, result) {\n    if(callback == null) return;\n    if(err) return handleCallback(callback, err, null);\n    handleCallback(callback, null, result.ok ? true : false);\n  });\n}\n\ndefine.classMethod('reIndex', {callback: true, promise:true});\n\n/**\n * Get the list of all indexes information for the collection.\n *\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {number} [options.batchSize=null] The batchSize for the returned command cursor or if pre 2.8 the systems batch collection\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @return {CommandCursor}\n */\nCollection.prototype.listIndexes = function(options) {\n  options = options || {};\n  // Clone the options\n  options = shallowClone(options);\n  // Determine the read preference in the options.\n  options = getReadPreference(this, options, this.s.db, this);\n  // Set the CommandCursor constructor\n  options.cursorFactory = CommandCursor;\n  // Set the promiseLibrary\n  options.promiseLibrary = this.s.promiseLibrary;\n\n  if(!this.s.topology.capabilities()) {\n    throw new MongoError('cannot connect to server');\n  }\n\n  // We have a list collections command\n  if(this.s.topology.capabilities().hasListIndexesCommand) {\n    // Cursor options\n    var cursor = options.batchSize ? {batchSize: options.batchSize} : {}\n    // Build the command\n    var command = { listIndexes: this.s.name, cursor: cursor };\n    // Execute the cursor\n    cursor = this.s.topology.cursor(f('%s.$cmd', this.s.dbName), command, options);\n    // Do we have a readPreference, apply it\n    if(options.readPreference) cursor.setReadPreference(options.readPreference);\n    // Return the cursor\n    return cursor;\n  }\n\n  // Get the namespace\n  var ns = f('%s.system.indexes', this.s.dbName);\n  // Get the query\n  cursor = this.s.topology.cursor(ns, {find: ns, query: {ns: this.s.namespace}}, options);\n  // Do we have a readPreference, apply it\n  if(options.readPreference) cursor.setReadPreference(options.readPreference);\n  // Set the passed in batch size if one was provided\n  if(options.batchSize) cursor = cursor.batchSize(options.batchSize);\n  // Return the cursor\n  return cursor;\n};\n\ndefine.classMethod('listIndexes', {callback: false, promise:false, returns: [CommandCursor]});\n\n/**\n * Ensures that an index exists, if it does not it creates it\n * @method\n * @deprecated use createIndexes instead\n * @param {(string|object)} fieldOrSpec Defines the index.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.unique=false] Creates an unique index.\n * @param {boolean} [options.sparse=false] Creates a sparse index.\n * @param {boolean} [options.background=false] Creates the index in the background, yielding whenever possible.\n * @param {boolean} [options.dropDups=false] A unique index cannot be created on a key that has pre-existing duplicate values. If you would like to create the index anyway, keeping the first document the database indexes and deleting all subsequent documents that have duplicate value\n * @param {number} [options.min=null] For geospatial indexes set the lower bound for the co-ordinates.\n * @param {number} [options.max=null] For geospatial indexes set the high bound for the co-ordinates.\n * @param {number} [options.v=null] Specify the format version of the indexes.\n * @param {number} [options.expireAfterSeconds=null] Allows you to expire data on indexes applied to a data (MongoDB 2.2 or higher)\n * @param {number} [options.name=null] Override the autogenerated index name (useful if the resulting name is larger than 128 bytes)\n * @param {object} [options.collation=null] Specify collation (MongoDB 3.4 or higher) settings for update operation (see 3.4 documentation for available fields).\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.ensureIndex = function(fieldOrSpec, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return ensureIndex(self, fieldOrSpec, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    ensureIndex(self, fieldOrSpec, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar ensureIndex = function(self, fieldOrSpec, options, callback) {\n  self.s.db.ensureIndex(self.s.name, fieldOrSpec, options, callback);\n}\n\ndefine.classMethod('ensureIndex', {callback: true, promise:true});\n\n/**\n * Checks if one or more indexes exist on the collection, fails on first non-existing index\n * @method\n * @param {(string|array)} indexes One or more index names to check.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.indexExists = function(indexes, callback) {\n  var self = this;\n\n  // Execute using callback\n  if(typeof callback == 'function') return indexExists(self, indexes, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    indexExists(self, indexes, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar indexExists = function(self, indexes, callback) {\n  self.indexInformation(function(err, indexInformation) {\n    // If we have an error return\n    if(err != null) return handleCallback(callback, err, null);\n    // Let's check for the index names\n    if(!Array.isArray(indexes)) return handleCallback(callback, null, indexInformation[indexes] != null);\n    // Check in list of indexes\n    for(var i = 0; i < indexes.length; i++) {\n      if(indexInformation[indexes[i]] == null) {\n        return handleCallback(callback, null, false);\n      }\n    }\n\n    // All keys found return true\n    return handleCallback(callback, null, true);\n  });\n}\n\ndefine.classMethod('indexExists', {callback: true, promise:true});\n\n/**\n * Retrieves this collections index info.\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.full=false] Returns the full raw index information.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.indexInformation = function(options, callback) {\n  var self = this;\n  // Unpack calls\n  var args = Array.prototype.slice.call(arguments, 0);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  options = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return indexInformation(self, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    indexInformation(self, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar indexInformation = function(self, options, callback) {\n  self.s.db.indexInformation(self.s.name, options, callback);\n}\n\ndefine.classMethod('indexInformation', {callback: true, promise:true});\n\n/**\n * The callback format for results\n * @callback Collection~countCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {number} result The count of documents that matched the query.\n */\n\n/**\n * Count number of matching documents in the db to a query.\n * @method\n * @param {object} query The query for the count.\n * @param {object} [options=null] Optional settings.\n * @param {boolean} [options.limit=null] The limit of documents to count.\n * @param {boolean} [options.skip=null] The number of documents to skip for the count.\n * @param {string} [options.hint=null] An index name hint for the query.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {number} [options.maxTimeMS=null] Number of miliseconds to wait before aborting the query.\n * @param {Collection~countCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.count = function(query, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 0);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  var queryOption = args.length ? args.shift() || {} : {};\n  var optionsOption = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return count(self, queryOption, optionsOption, callback);\n\n  // Check if query is empty\n  query = query || {};\n  options = options || {};\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    count(self, query, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n};\n\nvar count = function(self, query, options, callback) {\n  var skip = options.skip;\n  var limit = options.limit;\n  var hint = options.hint;\n  var maxTimeMS = options.maxTimeMS;\n\n  // Final query\n  var cmd = {\n    'count': self.s.name, 'query': query\n  };\n\n  // Add limit, skip and maxTimeMS if defined\n  if(typeof skip == 'number') cmd.skip = skip;\n  if(typeof limit == 'number') cmd.limit = limit;\n  if(typeof maxTimeMS == 'number') cmd.maxTimeMS = maxTimeMS;\n  if(hint) cmd.hint = hint;\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // Do we have a readConcern specified\n  if(self.s.readConcern) {\n    cmd.readConcern = self.s.readConcern;\n  }\n\n  // Have we specified collation\n  decorateWithCollation(cmd, self, options);\n\n  // Execute command\n  self.s.db.command(cmd, options, function(err, result) {\n    if(err) return handleCallback(callback, err);\n    handleCallback(callback, null, result.n);\n  });\n}\n\ndefine.classMethod('count', {callback: true, promise:true});\n\n/**\n * The distinct command returns returns a list of distinct values for the given key across a collection.\n * @method\n * @param {string} key Field of the document to find distinct values for.\n * @param {object} query The query for filtering the set of documents to which we apply the distinct filter.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {number} [options.maxTimeMS=null] Number of miliseconds to wait before aborting the query.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.distinct = function(key, query, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 1);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  var queryOption = args.length ? args.shift() || {} : {};\n  var optionsOption = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return distinct(self, key, queryOption, optionsOption, callback);\n\n  // Ensure the query and options are set\n  query = query || {};\n  options = options || {};\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    distinct(self, key, query, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n};\n\nvar distinct = function(self, key, query, options, callback) {\n  // maxTimeMS option\n  var maxTimeMS = options.maxTimeMS;\n\n  // Distinct command\n  var cmd = {\n    'distinct': self.s.name, 'key': key, 'query': query\n  };\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // Add maxTimeMS if defined\n  if(typeof maxTimeMS == 'number')\n    cmd.maxTimeMS = maxTimeMS;\n\n  // Do we have a readConcern specified\n  if(self.s.readConcern) {\n    cmd.readConcern = self.s.readConcern;\n  }\n\n  // Have we specified collation\n  decorateWithCollation(cmd, self, options);\n\n  // Execute the command\n  self.s.db.command(cmd, options, function(err, result) {\n    if(err) return handleCallback(callback, err);\n    handleCallback(callback, null, result.values);\n  });\n}\n\ndefine.classMethod('distinct', {callback: true, promise:true});\n\n/**\n * Retrieve all the indexes on the collection.\n * @method\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.indexes = function(callback) {\n  var self = this;\n  // Execute using callback\n  if(typeof callback == 'function') return indexes(self, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    indexes(self, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar indexes = function(self, callback) {\n  self.s.db.indexInformation(self.s.name, {full:true}, callback);\n}\n\ndefine.classMethod('indexes', {callback: true, promise:true});\n\n/**\n * Get all the collection statistics.\n *\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {number} [options.scale=null] Divide the returned sizes by scale value.\n * @param {Collection~resultCallback} [callback] The collection result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.stats = function(options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 0);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  // Fetch all commands\n  options = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return stats(self, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    stats(self, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar stats = function(self, options, callback) {\n  // Build command object\n  var commandObject = {\n    collStats:self.s.name\n  }\n\n  // Check if we have the scale value\n  if(options['scale'] != null) commandObject['scale'] = options['scale'];\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // Execute the command\n  self.s.db.command(commandObject, options, callback);\n}\n\ndefine.classMethod('stats', {callback: true, promise:true});\n\n/**\n * @typedef {Object} Collection~findAndModifyWriteOpResult\n * @property {object} value Document returned from findAndModify command.\n * @property {object} lastErrorObject The raw lastErrorObject returned from the command.\n * @property {Number} ok Is 1 if the command executed correctly.\n */\n\n/**\n * The callback format for inserts\n * @callback Collection~findAndModifyCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Collection~findAndModifyWriteOpResult} result The result object if the command was executed successfully.\n */\n\n/**\n * Find a document and delete it in one atomic operation, requires a write lock for the duration of the operation.\n *\n * @method\n * @param {object} filter Document selection filter.\n * @param {object} [options=null] Optional settings.\n * @param {object} [options.projection=null] Limits the fields to return for all matching documents.\n * @param {object} [options.sort=null] Determines which document the operation modifies if the query selects multiple documents.\n * @param {number} [options.maxTimeMS=null] The maximum amount of time to allow the query to run.\n * @param {Collection~findAndModifyCallback} [callback] The collection result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.findOneAndDelete = function(filter, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Basic validation\n  if(filter == null || typeof filter != 'object') throw toError('filter parameter must be an object');\n\n  // Execute using callback\n  if(typeof callback == 'function') return findOneAndDelete(self, filter, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    options = options || {};\n\n    findOneAndDelete(self, filter, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findOneAndDelete = function(self, filter, options, callback) {\n  // Final options\n  var finalOptions = shallowClone(options);\n  finalOptions['fields'] = options.projection;\n  finalOptions['remove'] = true;\n  // Execute find and Modify\n  self.findAndModify(\n      filter\n    , options.sort\n    , null\n    , finalOptions\n    , callback\n  );\n}\n\ndefine.classMethod('findOneAndDelete', {callback: true, promise:true});\n\n/**\n * Find a document and replace it in one atomic operation, requires a write lock for the duration of the operation.\n *\n * @method\n * @param {object} filter Document selection filter.\n * @param {object} replacement Document replacing the matching document.\n * @param {object} [options=null] Optional settings.\n * @param {object} [options.projection=null] Limits the fields to return for all matching documents.\n * @param {object} [options.sort=null] Determines which document the operation modifies if the query selects multiple documents.\n * @param {number} [options.maxTimeMS=null] The maximum amount of time to allow the query to run.\n * @param {boolean} [options.upsert=false] Upsert the document if it does not exist.\n * @param {boolean} [options.returnOriginal=true] When false, returns the updated document rather than the original. The default is true.\n * @param {Collection~findAndModifyCallback} [callback] The collection result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.findOneAndReplace = function(filter, replacement, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Basic validation\n  if(filter == null || typeof filter != 'object') throw toError('filter parameter must be an object');\n  if(replacement == null || typeof replacement != 'object') throw toError('replacement parameter must be an object');\n\n  // Execute using callback\n  if(typeof callback == 'function') return findOneAndReplace(self, filter, replacement, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    options = options || {};\n\n    findOneAndReplace(self, filter, replacement, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findOneAndReplace = function(self, filter, replacement, options, callback) {\n  // Final options\n  var finalOptions = shallowClone(options);\n  finalOptions['fields'] = options.projection;\n  finalOptions['update'] = true;\n  finalOptions['new'] = typeof options.returnOriginal == 'boolean' ? !options.returnOriginal : false;\n  finalOptions['upsert'] = typeof options.upsert == 'boolean' ? options.upsert : false;\n\n  // Execute findAndModify\n  self.findAndModify(\n      filter\n    , options.sort\n    , replacement\n    , finalOptions\n    , callback\n  );\n}\n\ndefine.classMethod('findOneAndReplace', {callback: true, promise:true});\n\n/**\n * Find a document and update it in one atomic operation, requires a write lock for the duration of the operation.\n *\n * @method\n * @param {object} filter Document selection filter.\n * @param {object} update Update operations to be performed on the document\n * @param {object} [options=null] Optional settings.\n * @param {object} [options.projection=null] Limits the fields to return for all matching documents.\n * @param {object} [options.sort=null] Determines which document the operation modifies if the query selects multiple documents.\n * @param {number} [options.maxTimeMS=null] The maximum amount of time to allow the query to run.\n * @param {boolean} [options.upsert=false] Upsert the document if it does not exist.\n * @param {boolean} [options.returnOriginal=true] When false, returns the updated document rather than the original. The default is true.\n * @param {Collection~findAndModifyCallback} [callback] The collection result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.findOneAndUpdate = function(filter, update, options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {};\n  options = options || {};\n\n  // Basic validation\n  if(filter == null || typeof filter != 'object') throw toError('filter parameter must be an object');\n  if(update == null || typeof update != 'object') throw toError('update parameter must be an object');\n\n  // Execute using callback\n  if(typeof callback == 'function') return findOneAndUpdate(self, filter, update, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    options = options || {};\n\n    findOneAndUpdate(self, filter, update, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findOneAndUpdate = function(self, filter, update, options, callback) {\n  // Final options\n  var finalOptions = shallowClone(options);\n  finalOptions['fields'] = options.projection;\n  finalOptions['update'] = true;\n  finalOptions['new'] = typeof options.returnOriginal == 'boolean' ? !options.returnOriginal : false;\n  finalOptions['upsert'] = typeof options.upsert == 'boolean' ? options.upsert : false;\n\n  // Execute findAndModify\n  self.findAndModify(\n      filter\n    , options.sort\n    , update\n    , finalOptions\n    , callback\n  );\n}\n\ndefine.classMethod('findOneAndUpdate', {callback: true, promise:true});\n\n/**\n * Find and update a document.\n * @method\n * @param {object} query Query object to locate the object to modify.\n * @param {array} sort If multiple docs match, choose the first one in the specified sort order as the object to manipulate.\n * @param {object} doc The fields/vals to be updated.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {boolean} [options.remove=false] Set to true to remove the object before returning.\n * @param {boolean} [options.upsert=false] Perform an upsert operation.\n * @param {boolean} [options.new=false] Set to true if you want to return the modified object rather than the original. Ignored for remove.\n * @param {object} [options.fields=null] Object containing the field projection for the result returned from the operation.\n * @param {Collection~findAndModifyCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated use findOneAndUpdate, findOneAndReplace or findOneAndDelete instead\n */\nCollection.prototype.findAndModify = function(query, sort, doc, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 1);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  sort = args.length ? args.shift() || [] : [];\n  doc = args.length ? args.shift() : null;\n  options = args.length ? args.shift() || {} : {};\n\n  // Clone options\n  options = shallowClone(options);\n  // Force read preference primary\n  options.readPreference = ReadPreference.PRIMARY;\n\n  // Execute using callback\n  if(typeof callback == 'function') return findAndModify(self, query, sort, doc, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    options = options || {};\n\n    findAndModify(self, query, sort, doc, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findAndModify = function(self, query, sort, doc, options, callback) {\n  // Create findAndModify command object\n  var queryObject = {\n     'findandmodify': self.s.name\n   , 'query': query\n  };\n\n  sort = formattedOrderClause(sort);\n  if(sort) {\n    queryObject.sort = sort;\n  }\n\n  queryObject.new = options.new ? true : false;\n  queryObject.remove = options.remove ? true : false;\n  queryObject.upsert = options.upsert ? true : false;\n\n  if(options.fields) {\n    queryObject.fields = options.fields;\n  }\n\n  if(doc && !options.remove) {\n    queryObject.update = doc;\n  }\n\n  if(options.maxTimeMS)\n    queryObject.maxTimeMS = options.maxTimeMS;\n\n  // Either use override on the function, or go back to default on either the collection\n  // level or db\n  if(options['serializeFunctions'] != null) {\n    options['serializeFunctions'] = options['serializeFunctions'];\n  } else {\n    options['serializeFunctions'] = self.s.serializeFunctions;\n  }\n\n  // No check on the documents\n  options.checkKeys = false;\n\n  // Get the write concern settings\n  var finalOptions = writeConcern(options, self.s.db, self, options);\n\n  // Decorate the findAndModify command with the write Concern\n  if(finalOptions.writeConcern) {\n    queryObject.writeConcern = finalOptions.writeConcern;\n  }\n\n  // Have we specified bypassDocumentValidation\n  if(typeof finalOptions.bypassDocumentValidation == 'boolean') {\n    queryObject.bypassDocumentValidation = finalOptions.bypassDocumentValidation;\n  }\n\n  // Have we specified collation\n  decorateWithCollation(queryObject, self, options);\n\n  // Execute the command\n  self.s.db.command(queryObject\n    , options, function(err, result) {\n      if(err) return handleCallback(callback, err, null);\n      return handleCallback(callback, null, result);\n  });\n}\n\ndefine.classMethod('findAndModify', {callback: true, promise:true});\n\n/**\n * Find and remove a document.\n * @method\n * @param {object} query Query object to locate the object to modify.\n * @param {array} sort If multiple docs match, choose the first one in the specified sort order as the object to manipulate.\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated use findOneAndDelete instead\n */\nCollection.prototype.findAndRemove = function(query, sort, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 1);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  sort = args.length ? args.shift() || [] : [];\n  options = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return findAndRemove(self, query, sort, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    findAndRemove(self, query, sort, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar findAndRemove = function(self, query, sort, options, callback) {\n  // Add the remove option\n  options['remove'] = true;\n  // Execute the callback\n  self.findAndModify(query, sort, null, options, callback);\n}\n\ndefine.classMethod('findAndRemove', {callback: true, promise:true});\n\nfunction decorateWithWriteConcern(command, self, options) {\n  // Do we support collation 3.4 and higher\n  var capabilities = self.s.topology.capabilities();\n  // Do we support write concerns 3.4 and higher\n  if(capabilities && capabilities.commandsTakeWriteConcern) {\n    // Get the write concern settings\n    var finalOptions = writeConcern(shallowClone(options), self.s.db, self, options);\n    // Add the write concern to the command\n    if(finalOptions.writeConcern) {\n      command.writeConcern = finalOptions.writeConcern;\n    }\n  }\n}\n\nfunction decorateWithCollation(command, self, options) {\n  // Do we support collation 3.4 and higher\n  var capabilities = self.s.topology.capabilities();\n  // Do we support write concerns 3.4 and higher\n  if(capabilities && capabilities.commandsTakeCollation) {\n    if(options.collation && typeof options.collation == 'object') {\n      command.collation = options.collation;\n    }\n  }\n}\n\n/**\n * Execute an aggregation framework pipeline against the collection, needs MongoDB >= 2.2\n * @method\n * @param {object} pipeline Array containing all the aggregation framework commands for the execution.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {object} [options.cursor=null] Return the query as cursor, on 2.6 > it returns as a real cursor on pre 2.6 it returns as an emulated cursor.\n * @param {number} [options.cursor.batchSize=null] The batchSize for the cursor\n * @param {boolean} [options.explain=false] Explain returns the aggregation execution plan (requires mongodb 2.6 >).\n * @param {boolean} [options.allowDiskUse=false] allowDiskUse lets the server know if it can use disk to store temporary results for the aggregation (requires mongodb 2.6 >).\n * @param {number} [options.maxTimeMS=null] maxTimeMS specifies a cumulative time limit in milliseconds for processing operations on the cursor. MongoDB interrupts the operation at the earliest following interrupt point.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {boolean} [options.raw=false] Return document results as raw BSON buffers.\n * @param {boolean} [options.promoteLongs=true] Promotes Long values to number if they fit inside the 53 bits resolution.\n * @param {boolean} [options.promoteValues=true] Promotes BSON values to native types where possible, set to false to only receive wrapper types.\n * @param {boolean} [options.promoteBuffers=false] Promotes Binary BSON values to native Node Buffers.\n * @param {object} [options.collation=null] Specify collation (MongoDB 3.4 or higher) settings for update operation (see 3.4 documentation for available fields).\n * @param {Collection~resultCallback} callback The command result callback\n * @return {(null|AggregationCursor)}\n */\nCollection.prototype.aggregate = function(pipeline, options, callback) {\n  var self = this;\n\n  if(Array.isArray(pipeline)) {\n    // Set up callback if one is provided\n    if(typeof options == 'function') {\n      callback = options;\n      options = {};\n    }\n\n    // If we have no options or callback we are doing\n    // a cursor based aggregation\n    if(options == null && callback == null) {\n      options = {};\n    }\n  } else {\n    // Aggregation pipeline passed as arguments on the method\n    var args = Array.prototype.slice.call(arguments, 0);\n    // Get the callback\n    callback = args.pop();\n    // Get the possible options object\n    var opts = args[args.length - 1];\n    // If it contains any of the admissible options pop it of the args\n    options = opts && (opts.readPreference\n      || opts.explain || opts.cursor || opts.out\n      || opts.maxTimeMS || opts.allowDiskUse) ? args.pop() : {};\n      // Left over arguments is the pipeline\n    pipeline = args;\n  }\n\n  // Ignore readConcern option\n  var ignoreReadConcern = false;\n\n  // Build the command\n  var command = { aggregate : this.s.name, pipeline : pipeline};\n\n  // If out was specified\n  if(typeof options.out == 'string') {\n    pipeline.push({$out: options.out});\n    // Ignore read concern\n    ignoreReadConcern = true;\n  } else if(pipeline.length > 0 && pipeline[pipeline.length - 1]['$out']) {\n    ignoreReadConcern = true;\n  }\n\n  // Decorate command with writeConcern if out has been specified\n  if(pipeline.length > 0 && pipeline[pipeline.length - 1]['$out']) {\n    decorateWithWriteConcern(command, self, options);\n  }\n\n  // Have we specified collation\n  decorateWithCollation(command, self, options);\n\n  // If we have bypassDocumentValidation set\n  if(typeof options.bypassDocumentValidation == 'boolean') {\n    command.bypassDocumentValidation = options.bypassDocumentValidation;\n  }\n\n  // Do we have a readConcern specified\n  if(!ignoreReadConcern && this.s.readConcern) {\n    command.readConcern = this.s.readConcern;\n  }\n\n  // If we have allowDiskUse defined\n  if(options.allowDiskUse) command.allowDiskUse = options.allowDiskUse;\n  if(typeof options.maxTimeMS == 'number') command.maxTimeMS = options.maxTimeMS;\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(this, options, this.s.db, this);\n\n  // If explain has been specified add it\n  if(options.explain) command.explain = options.explain;\n\n  // Validate that cursor options is valid\n  if(options.cursor != null && typeof options.cursor != 'object') {\n    throw toError('cursor options must be an object');\n  }\n\n  // promiseLibrary\n  options.promiseLibrary = this.s.promiseLibrary;\n\n  // Set the AggregationCursor constructor\n  options.cursorFactory = AggregationCursor;\n  if(typeof callback != 'function') {\n    if(!this.s.topology.capabilities()) {\n      throw new MongoError('cannot connect to server');\n    }\n\n    if(this.s.topology.capabilities().hasAggregationCursor) {\n      options.cursor = options.cursor || { batchSize : 1000 };\n      command.cursor = options.cursor;\n    }\n\n    // Allow disk usage command\n    if(typeof options.allowDiskUse == 'boolean') command.allowDiskUse = options.allowDiskUse;\n    if(typeof options.maxTimeMS == 'number') command.maxTimeMS = options.maxTimeMS;\n\n    // Execute the cursor\n    return this.s.topology.cursor(this.s.namespace, command, options);\n  }\n\n  // We do not allow cursor\n  if(options.cursor) {\n    return this.s.topology.cursor(this.s.namespace, command, options);\n  }\n\n  // Execute the command\n  this.s.db.command(command, options, function(err, result) {\n    if(err) {\n      handleCallback(callback, err);\n    } else if(result['err'] || result['errmsg']) {\n      handleCallback(callback, toError(result));\n    } else if(typeof result == 'object' && result['serverPipeline']) {\n      handleCallback(callback, null, result['serverPipeline']);\n    } else if(typeof result == 'object' && result['stages']) {\n      handleCallback(callback, null, result['stages']);\n    } else {\n      handleCallback(callback, null, result.result);\n    }\n  });\n}\n\ndefine.classMethod('aggregate', {callback: true, promise:false});\n\n/**\n * The callback format for results\n * @callback Collection~parallelCollectionScanCallback\n * @param {MongoError} error An error instance representing the error during the execution.\n * @param {Cursor[]} cursors A list of cursors returned allowing for parallel reading of collection.\n */\n\n/**\n * Return N number of parallel cursors for a collection allowing parallel reading of entire collection. There are\n * no ordering guarantees for returned results.\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {number} [options.batchSize=null] Set the batchSize for the getMoreCommand when iterating over the query results.\n * @param {number} [options.numCursors=1] The maximum number of parallel command cursors to return (the number of returned cursors will be in the range 1:numCursors)\n * @param {boolean} [options.raw=false] Return all BSON documents as Raw Buffer documents.\n * @param {Collection~parallelCollectionScanCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.parallelCollectionScan = function(options, callback) {\n  var self = this;\n  if(typeof options == 'function') callback = options, options = {numCursors: 1};\n  // Set number of cursors to 1\n  options.numCursors = options.numCursors || 1;\n  options.batchSize = options.batchSize || 1000;\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(this, options, this.s.db, this);\n\n  // Add a promiseLibrary\n  options.promiseLibrary = this.s.promiseLibrary;\n\n  // Execute using callback\n  if(typeof callback == 'function') return parallelCollectionScan(self, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    parallelCollectionScan(self, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar parallelCollectionScan = function(self, options, callback) {\n  // Create command object\n  var commandObject = {\n      parallelCollectionScan: self.s.name\n    , numCursors: options.numCursors\n  }\n\n  // Do we have a readConcern specified\n  if(self.s.readConcern) {\n    commandObject.readConcern = self.s.readConcern;\n  }\n\n  // Store the raw value\n  var raw = options.raw;\n  delete options['raw'];\n\n  // Execute the command\n  self.s.db.command(commandObject, options, function(err, result) {\n    if(err) return handleCallback(callback, err, null);\n    if(result == null) return handleCallback(callback, new Error(\"no result returned for parallelCollectionScan\"), null);\n\n    var cursors = [];\n    // Add the raw back to the option\n    if(raw) options.raw = raw;\n    // Create command cursors for each item\n    for(var i = 0; i < result.cursors.length; i++) {\n      var rawId = result.cursors[i].cursor.id\n      // Convert cursorId to Long if needed\n      var cursorId = typeof rawId == 'number' ? Long.fromNumber(rawId) : rawId;\n      // Add a command cursor\n      cursors.push(self.s.topology.cursor(self.s.namespace, cursorId, options));\n    }\n\n    handleCallback(callback, null, cursors);\n  });\n}\n\ndefine.classMethod('parallelCollectionScan', {callback: true, promise:true});\n\n/**\n * Execute the geoNear command to search for items in the collection\n *\n * @method\n * @param {number} x Point to search on the x axis, ensure the indexes are ordered in the same order.\n * @param {number} y Point to search on the y axis, ensure the indexes are ordered in the same order.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {number} [options.num=null] Max number of results to return.\n * @param {number} [options.minDistance=null] Include results starting at minDistance from a point (2.6 or higher)\n * @param {number} [options.maxDistance=null] Include results up to maxDistance from the point.\n * @param {number} [options.distanceMultiplier=null] Include a value to multiply the distances with allowing for range conversions.\n * @param {object} [options.query=null] Filter the results by a query.\n * @param {boolean} [options.spherical=false] Perform query using a spherical model.\n * @param {boolean} [options.uniqueDocs=false] The closest location in a document to the center of the search region will always be returned MongoDB > 2.X.\n * @param {boolean} [options.includeLocs=false] Include the location data fields in the top level of the results MongoDB > 2.X.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.geoNear = function(x, y, options, callback) {\n  var self = this;\n  var point = typeof(x) == 'object' && x\n    , args = Array.prototype.slice.call(arguments, point?1:2);\n\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  // Fetch all commands\n  options = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return geoNear(self, x, y, point, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    geoNear(self, x, y, point, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar geoNear = function(self, x, y, point, options, callback) {\n  // Build command object\n  var commandObject = {\n    geoNear:self.s.name,\n    near: point || [x, y]\n  }\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // Exclude readPreference and existing options to prevent user from\n  // shooting themselves in the foot\n  var exclude = {\n    readPreference: true,\n    geoNear: true,\n    near: true\n  };\n\n  // Filter out any excluded objects\n  commandObject = decorateCommand(commandObject, options, exclude);\n\n  // Do we have a readConcern specified\n  if(self.s.readConcern) {\n    commandObject.readConcern = self.s.readConcern;\n  }\n\n  // Have we specified collation\n  decorateWithCollation(commandObject, self, options);\n\n  // Execute the command\n  self.s.db.command(commandObject, options, function (err, res) {\n    if(err) return handleCallback(callback, err);\n    if(res.err || res.errmsg) return handleCallback(callback, toError(res));\n    // should we only be returning res.results here? Not sure if the user\n    // should see the other return information\n    handleCallback(callback, null, res);\n  });\n}\n\ndefine.classMethod('geoNear', {callback: true, promise:true});\n\n/**\n * Execute a geo search using a geo haystack index on a collection.\n *\n * @method\n * @param {number} x Point to search on the x axis, ensure the indexes are ordered in the same order.\n * @param {number} y Point to search on the y axis, ensure the indexes are ordered in the same order.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {number} [options.maxDistance=null] Include results up to maxDistance from the point.\n * @param {object} [options.search=null] Filter the results by a query.\n * @param {number} [options.limit=false] Max number of results to return.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.geoHaystackSearch = function(x, y, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 2);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  // Fetch all commands\n  options = args.length ? args.shift() || {} : {};\n\n  // Execute using callback\n  if(typeof callback == 'function') return geoHaystackSearch(self, x, y, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    geoHaystackSearch(self, x, y, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar geoHaystackSearch = function(self, x, y, options, callback) {\n  // Build command object\n  var commandObject = {\n    geoSearch: self.s.name,\n    near: [x, y]\n  }\n\n  // Remove read preference from hash if it exists\n  commandObject = decorateCommand(commandObject, options, {readPreference: true});\n\n  options = shallowClone(options);\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // Do we have a readConcern specified\n  if(self.s.readConcern) {\n    commandObject.readConcern = self.s.readConcern;\n  }\n\n  // Execute the command\n  self.s.db.command(commandObject, options, function (err, res) {\n    if(err) return handleCallback(callback, err);\n    if(res.err || res.errmsg) handleCallback(callback, toError(res));\n    // should we only be returning res.results here? Not sure if the user\n    // should see the other return information\n    handleCallback(callback, null, res);\n  });\n}\n\ndefine.classMethod('geoHaystackSearch', {callback: true, promise:true});\n\n/**\n * Group function helper\n * @ignore\n */\n// var groupFunction = function () {\n//   var c = db[ns].find(condition);\n//   var map = new Map();\n//   var reduce_function = reduce;\n//\n//   while (c.hasNext()) {\n//     var obj = c.next();\n//     var key = {};\n//\n//     for (var i = 0, len = keys.length; i < len; ++i) {\n//       var k = keys[i];\n//       key[k] = obj[k];\n//     }\n//\n//     var aggObj = map.get(key);\n//\n//     if (aggObj == null) {\n//       var newObj = Object.extend({}, key);\n//       aggObj = Object.extend(newObj, initial);\n//       map.put(key, aggObj);\n//     }\n//\n//     reduce_function(obj, aggObj);\n//   }\n//\n//   return { \"result\": map.values() };\n// }.toString();\nvar groupFunction = 'function () {\\nvar c = db[ns].find(condition);\\nvar map = new Map();\\nvar reduce_function = reduce;\\n\\nwhile (c.hasNext()) {\\nvar obj = c.next();\\nvar key = {};\\n\\nfor (var i = 0, len = keys.length; i < len; ++i) {\\nvar k = keys[i];\\nkey[k] = obj[k];\\n}\\n\\nvar aggObj = map.get(key);\\n\\nif (aggObj == null) {\\nvar newObj = Object.extend({}, key);\\naggObj = Object.extend(newObj, initial);\\nmap.put(key, aggObj);\\n}\\n\\nreduce_function(obj, aggObj);\\n}\\n\\nreturn { \"result\": map.values() };\\n}';\n\n/**\n * Run a group command across a collection\n *\n * @method\n * @param {(object|array|function|code)} keys An object, array or function expressing the keys to group by.\n * @param {object} condition An optional condition that must be true for a row to be considered.\n * @param {object} initial Initial value of the aggregation counter object.\n * @param {(function|Code)} reduce The reduce function aggregates (reduces) the objects iterated\n * @param {(function|Code)} finalize An optional function to be run on each item in the result set just before the item is returned.\n * @param {boolean} command Specify if you wish to run using the internal group command or using eval, default is true.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {Collection~resultCallback} [callback] The command result callback\n * @return {Promise} returns Promise if no callback passed\n * @deprecated MongoDB 3.6 or higher will no longer support the group command. We recommend rewriting using the aggregation framework.\n */\nCollection.prototype.group = function(keys, condition, initial, reduce, finalize, command, options, callback) {\n  var self = this;\n  var args = Array.prototype.slice.call(arguments, 3);\n  callback = args.pop();\n  if(typeof callback != 'function') args.push(callback);\n  // Fetch all commands\n  reduce = args.length ? args.shift() : null;\n  finalize = args.length ? args.shift() : null;\n  command = args.length ? args.shift() : null;\n  options = args.length ? args.shift() || {} : {};\n\n  // Make sure we are backward compatible\n  if(!(typeof finalize == 'function')) {\n    command = finalize;\n    finalize = null;\n  }\n\n  if (!Array.isArray(keys) && keys instanceof Object && typeof(keys) !== 'function' && !(keys._bsontype == 'Code')) {\n    keys = Object.keys(keys);\n  }\n\n  if(typeof reduce === 'function') {\n    reduce = reduce.toString();\n  }\n\n  if(typeof finalize === 'function') {\n    finalize = finalize.toString();\n  }\n\n  // Set up the command as default\n  command = command == null ? true : command;\n\n  // Execute using callback\n  if(typeof callback == 'function') return group(self, keys, condition, initial, reduce, finalize, command, options, callback);\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    group(self, keys, condition, initial, reduce, finalize, command, options, function(err, r) {\n      if(err) return reject(err);\n      resolve(r);\n    });\n  });\n}\n\nvar group = function(self, keys, condition, initial, reduce, finalize, command, options, callback) {\n  // Execute using the command\n  if(command) {\n    var reduceFunction = reduce && reduce._bsontype == 'Code'\n        ? reduce\n        : new Code(reduce);\n\n    var selector = {\n      group: {\n          'ns': self.s.name\n        , '$reduce': reduceFunction\n        , 'cond': condition\n        , 'initial': initial\n        , 'out': \"inline\"\n      }\n    };\n\n    // if finalize is defined\n    if(finalize != null) selector.group['finalize'] = finalize;\n    // Set up group selector\n    if ('function' === typeof keys || (keys && keys._bsontype == 'Code')) {\n      selector.group.$keyf = keys && keys._bsontype == 'Code'\n        ? keys\n        : new Code(keys);\n    } else {\n      var hash = {};\n      keys.forEach(function (key) {\n        hash[key] = 1;\n      });\n      selector.group.key = hash;\n    }\n\n    options = shallowClone(options);\n    // Ensure we have the right read preference inheritance\n    options = getReadPreference(self, options, self.s.db, self);\n\n    // Do we have a readConcern specified\n    if(self.s.readConcern) {\n      selector.readConcern = self.s.readConcern;\n    }\n\n    // Have we specified collation\n    decorateWithCollation(selector, self, options);\n\n    // Execute command\n    self.s.db.command(selector, options, function(err, result) {\n      if(err) return handleCallback(callback, err, null);\n      handleCallback(callback, null, result.retval);\n    });\n  } else {\n    // Create execution scope\n    var scope = reduce != null && reduce._bsontype == 'Code'\n      ? reduce.scope\n      : {};\n\n    scope.ns = self.s.name;\n    scope.keys = keys;\n    scope.condition = condition;\n    scope.initial = initial;\n\n    // Pass in the function text to execute within mongodb.\n    var groupfn = groupFunction.replace(/ reduce;/, reduce.toString() + ';');\n\n    self.s.db.eval(new Code(groupfn, scope), function (err, results) {\n      if (err) return handleCallback(callback, err, null);\n      handleCallback(callback, null, results.result || results);\n    });\n  }\n}\n\ndefine.classMethod('group', {callback: true, promise:true});\n\n/**\n * Functions that are passed as scope args must\n * be converted to Code instances.\n * @ignore\n */\nfunction processScope (scope) {\n  if(!isObject(scope) || scope._bsontype == 'ObjectID') {\n    return scope;\n  }\n\n  var keys = Object.keys(scope);\n  var i = keys.length;\n  var key;\n  var new_scope = {};\n\n  while (i--) {\n    key = keys[i];\n    if ('function' == typeof scope[key]) {\n      new_scope[key] = new Code(String(scope[key]));\n    } else {\n      new_scope[key] = processScope(scope[key]);\n    }\n  }\n\n  return new_scope;\n}\n\n/**\n * Run Map Reduce across a collection. Be aware that the inline option for out will return an array of results not a collection.\n *\n * @method\n * @param {(function|string)} map The mapping function.\n * @param {(function|string)} reduce The reduce function.\n * @param {object} [options=null] Optional settings.\n * @param {(ReadPreference|string)} [options.readPreference=null] The preferred read preference (ReadPreference.PRIMARY, ReadPreference.PRIMARY_PREFERRED, ReadPreference.SECONDARY, ReadPreference.SECONDARY_PREFERRED, ReadPreference.NEAREST).\n * @param {object} [options.out=null] Sets the output target for the map reduce job. *{inline:1} | {replace:'collectionName'} | {merge:'collectionName'} | {reduce:'collectionName'}*\n * @param {object} [options.query=null] Query filter object.\n * @param {object} [options.sort=null] Sorts the input objects using this key. Useful for optimization, like sorting by the emit key for fewer reduces.\n * @param {number} [options.limit=null] Number of objects to return from collection.\n * @param {boolean} [options.keeptemp=false] Keep temporary data.\n * @param {(function|string)} [options.finalize=null] Finalize function.\n * @param {object} [options.scope=null] Can pass in variables that can be access from map/reduce/finalize.\n * @param {boolean} [options.jsMode=false] It is possible to make the execution stay in JS. Provided in MongoDB > 2.0.X.\n * @param {boolean} [options.verbose=false] Provide statistics on job execution time.\n * @param {boolean} [options.bypassDocumentValidation=false] Allow driver to bypass schema validation in MongoDB 3.2 or higher.\n * @param {Collection~resultCallback} [callback] The command result callback\n * @throws {MongoError}\n * @return {Promise} returns Promise if no callback passed\n */\nCollection.prototype.mapReduce = function(map, reduce, options, callback) {\n  var self = this;\n  if('function' === typeof options) callback = options, options = {};\n  // Out must allways be defined (make sure we don't break weirdly on pre 1.8+ servers)\n  if(null == options.out) {\n    throw new Error(\"the out option parameter must be defined, see mongodb docs for possible values\");\n  }\n\n  if('function' === typeof map) {\n    map = map.toString();\n  }\n\n  if('function' === typeof reduce) {\n    reduce = reduce.toString();\n  }\n\n  if('function' === typeof options.finalize) {\n    options.finalize = options.finalize.toString();\n  }\n\n  // Execute using callback\n  if(typeof callback == 'function') return mapReduce(self, map, reduce, options, callback);\n\n  // Return a Promise\n  return new this.s.promiseLibrary(function(resolve, reject) {\n    mapReduce(self, map, reduce, options, function(err, r, r1) {\n      if(err) return reject(err);\n      if(!r1) return resolve(r);\n      resolve({results: r, stats: r1});\n    });\n  });\n}\n\nvar mapReduce = function(self, map, reduce, options, callback) {\n  var mapCommandHash = {\n      mapreduce: self.s.name\n    , map: map\n    , reduce: reduce\n  };\n\n  // Exclusion list\n  var exclusionList = ['readPreference'];\n\n  // Add any other options passed in\n  for(var n in options) {\n    if('scope' == n) {\n      mapCommandHash[n] = processScope(options[n]);\n    } else {\n      // Only include if not in exclusion list\n      if(exclusionList.indexOf(n) == -1) {\n        mapCommandHash[n] = options[n];\n      }\n    }\n  }\n\n  options = shallowClone(options);\n\n  // Ensure we have the right read preference inheritance\n  options = getReadPreference(self, options, self.s.db, self);\n\n  // If we have a read preference and inline is not set as output fail hard\n  if((options.readPreference != false && options.readPreference != 'primary')\n    && options['out'] && (options['out'].inline != 1 && options['out'] != 'inline')) {\n      // Force readPreference to primary\n      options.readPreference = 'primary';\n      // Decorate command with writeConcern if supported\n      decorateWithWriteConcern(mapCommandHash, self, options);\n  } else if(self.s.readConcern) {\n    mapCommandHash.readConcern = self.s.readConcern;\n  }\n\n  // Is bypassDocumentValidation specified\n  if(typeof options.bypassDocumentValidation == 'boolean') {\n    mapCommandHash.bypassDocumentValidation = options.bypassDocumentValidation;\n  }\n\n  // Have we specified collation\n  decorateWithCollation(mapCommandHash, self, options);\n\n  // Execute command\n  self.s.db.command(mapCommandHash, {readPreference:options.readPreference}, function (err, result) {\n    if(err) return handleCallback(callback, err);\n    // Check if we have an error\n    if(1 != result.ok || result.err || result.errmsg) {\n      return handleCallback(callback, toError(result));\n    }\n\n    // Create statistics value\n    var stats = {};\n    if(result.timeMillis) stats['processtime'] = result.timeMillis;\n    if(result.counts) stats['counts'] = result.counts;\n    if(result.timing) stats['timing'] = result.timing;\n\n    // invoked with inline?\n    if(result.results) {\n      // If we wish for no verbosity\n      if(options['verbose'] == null || !options['verbose']) {\n        return handleCallback(callback, null, result.results);\n      }\n\n      return handleCallback(callback, null, result.results, stats);\n    }\n\n    // The returned collection\n    var collection = null;\n\n    // If we have an object it's a different db\n    if(result.result != null && typeof result.result == 'object') {\n      var doc = result.result;\n      collection = self.s.db.db(doc.db).collection(doc.collection);\n    } else {\n      // Create a collection object that wraps the result collection\n      collection = self.s.db.collection(result.result)\n    }\n\n    // If we wish for no verbosity\n    if(options['verbose'] == null || !options['verbose']) {\n      return handleCallback(callback, err, collection);\n    }\n\n    // Return stats as third set of values\n    handleCallback(callback, err, collection, stats);\n  });\n}\n\ndefine.classMethod('mapReduce', {callback: true, promise:true});\n\n/**\n * Initiate a Out of order batch write operation. All operations will be buffered into insert/update/remove commands executed out of order.\n *\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @return {UnorderedBulkOperation}\n */\nCollection.prototype.initializeUnorderedBulkOp = function(options) {\n  options = options || {};\n  options.promiseLibrary = this.s.promiseLibrary;\n  return unordered(this.s.topology, this, options);\n}\n\ndefine.classMethod('initializeUnorderedBulkOp', {callback: false, promise:false, returns: [ordered.UnorderedBulkOperation]});\n\n/**\n * Initiate an In order bulk write operation, operations will be serially executed in the order they are added, creating a new operation for each switch in types.\n *\n * @method\n * @param {object} [options=null] Optional settings.\n * @param {(number|string)} [options.w=null] The write concern.\n * @param {number} [options.wtimeout=null] The write concern timeout.\n * @param {boolean} [options.j=false] Specify a journal write concern.\n * @param {OrderedBulkOperation} callback The command result callback\n * @return {null}\n */\nCollection.prototype.initializeOrderedBulkOp = function(options) {\n  options = options || {};\n  options.promiseLibrary = this.s.promiseLibrary;\n  return ordered(this.s.topology, this, options);\n}\n\ndefine.classMethod('initializeOrderedBulkOp', {callback: false, promise:false, returns: [ordered.OrderedBulkOperation]});\n\n// Get write concern\nvar writeConcern = function(target, db, col, options) {\n  if(options.w != null || options.j != null || options.fsync != null) {\n    var opts = {};\n    if(options.w != null) opts.w = options.w;\n    if(options.wtimeout != null) opts.wtimeout = options.wtimeout;\n    if(options.j != null) opts.j = options.j;\n    if(options.fsync != null) opts.fsync = options.fsync;\n    target.writeConcern = opts;\n  } else if(col.writeConcern.w != null || col.writeConcern.j != null || col.writeConcern.fsync != null) {\n    target.writeConcern = col.writeConcern;\n  } else if(db.writeConcern.w != null || db.writeConcern.j != null || db.writeConcern.fsync != null) {\n    target.writeConcern = db.writeConcern;\n  }\n\n  return target\n}\n\n// Figure out the read preference\nvar getReadPreference = function(self, options, db) {\n  var r = null\n  if(options.readPreference) {\n    r = options.readPreference\n  } else if(self.s.readPreference) {\n    r = self.s.readPreference\n  } else if(db.s.readPreference) {\n    r = db.s.readPreference;\n  }\n\n  if(r instanceof ReadPreference) {\n    options.readPreference = new CoreReadPreference(r.mode, r.tags, {maxStalenessSeconds: r.maxStalenessSeconds});\n  } else if(typeof r == 'string') {\n    options.readPreference = new CoreReadPreference(r);\n  } else if(r && !(r instanceof ReadPreference) && typeof r == 'object') {\n    var mode = r.mode || r.preference;\n    if (mode && typeof mode == 'string') {\n      options.readPreference = new CoreReadPreference(mode, r.tags, {maxStalenessSeconds: r.maxStalenessSeconds});\n    }\n  }\n\n  return options;\n}\n\nvar testForFields = {\n    limit: 1, sort: 1, fields:1, skip: 1, hint: 1, explain: 1, snapshot: 1, timeout: 1, tailable: 1, tailableRetryInterval: 1\n  , numberOfRetries: 1, awaitdata: 1, awaitData: 1, exhaust: 1, batchSize: 1, returnKey: 1, maxScan: 1, min: 1, max: 1, showDiskLoc: 1\n  , comment: 1, raw: 1, readPreference: 1, partial: 1, read: 1, dbName: 1, oplogReplay: 1, connection: 1, maxTimeMS: 1, transforms: 1\n  , collation: 1\n}\n\nmodule.exports = Collection;\n"]}