{"version":3,"sources":["app.js"],"names":[],"mappings":"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","file":"app-compiled.js","sourcesContent":["var express = require('express');\nvar bodyParser = require('body-parser');\nvar MongoClient = require('mongodb').MongoClient;\nvar ObjectID = require('mongodb').ObjectID;\nvar db = require('./db');\nvar eventsController = require('./controllers/events');\nvar eventsModel = require('./models/events');\nvar path = require('path');\nvar request = require('request');\nvar cheerio = require('cheerio');\nvar fs = require('fs');\nvar encoding = require('encoding');\nvar jquery = require('jquery');\nvar Nightmare = require('nightmare');\nnightmare = Nightmare();\nvar app = express();\nconst VK = require('vk-io');\nconst vk = new VK({\n    app: 5980502,\n    login: 'ilia.fyodoroff@mail.ru',\n    pass: 'zxcfghb12QLNkftMGS44078',\n    phone: '+79220291925',\n    scope: 'stats,notifications,groups,wall,pages,friends,offline,photos,market'\n});\n//var ABC = [\"в\",\"с\",\"до\",\"от\",\"2017\",\"по\",\"на\",\"за\",\"для\",\"фестиваль\",\"день\",\"уроки\",\"встреча\",\"отдых\",\"МК\"];\n//var CitiesID = [96, 1, 2, 10, 37, 153, 49, 60, 61, 72, 73, 95, 99, 104, 110, 119, 123, 151, 158];\n//var CitiesID = ['96','1','2','10','37','153','49','60','61','72','73','95','99','104','110','119','123','151','158'];\nvar ABC = [\"в\"];\nvar CitiesID = ['96'];\n\nvar mergeName = [];\n\nvar groupID = [];\nvar groupName = [];\nvar groupActivity = [];\nvar groupPhoto = [];\nvar groupStartdate= [];\nvar groupLatitude = [];\nvar groupLongitude = [];\n\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\nconst auth = vk.auth.standalone();\n\nfunction arrayUnique(arr){\n    return arr.filter((e,i,a)=>a.indexOf(e)==i)\n}\n\n\n\n\n\nfunction parseDataFromSite(result, c) {\n    return new Promise(function (resolve, reject) {\n        setTimeout(function () {\n            nightmare.goto('https://vk.com/search?c%5Bcity%5D=' + CitiesID[c] + '&c%5Bcountry%5D=1&c%5Bsection%5D=communities&c%5Bskip_catalog%5D=1&c%5Btype%5D=3')\n                .wait(2000)\n                .inject('js', './jquery_v1_10_2.js')\n                .wait(2000)\n                .scrollTo(999999999999999999999999999,0)\n                .wait(5000)\n                .evaluate(function () {\n                    var shortNames = [];\n                    $('.labeled.title a').each(function () {\n                        var item = $(this).attr('href');\n                        $.trim(item);\n                        item = item.replace('/','');\n                        item = item.replace('event','club');\n                        shortNames.push(item)\n                    });\n\n                    console.log('shortNames:', shortNames);\n\n                    mergeName = result.concat(shortNames);\n                    mergeName = arrayUnique(mergeName);\n\n                    var mergeResult = mergeName.join(',');\n                    if (mergeResult) {\n                        resolve(mergeResult);\n                    } else {\n                        reject('Ошибка при парсе данных с сайта');\n                    }\n\n                })\n        }, 12000);\n    })\n}\n\nfunction tryGetGroupData(j, c) {\n    return function () {\n        console.log('Счетчик слов: ', j);\n        console.log('Счетчик городов: ', c);\n        vk.api.groups.search({\n                q: ABC[j],\n                type: 'event',\n                city_id: CitiesID[c],\n                future: 1,\n                offset: 0,\n                count: 1000\n            })\n            .then((group) => {\n                var result = [];\n\n                console.log('Первое поиское слово: ', ABC[j]);\n                console.log('Groups:', group)\n                var groupObj = JSON.stringify(group);\n                var groupJSON = JSON.parse(groupObj);\n                for (var i = 0; i < groupJSON.items.length; i++) {\n                    result.push(groupJSON.items[i].screen_name); // все id по словарю для заданного города\n                }\n                result = arrayUnique(result); // удаляем дублирующиеся данные\n                console.info('Value \"c\" after API request: ', c);\n\n                return result;\n            })\n            .then(function (result) {\n                return new Promise(function (resolve, reject) {\n                    console.log('then Result: ', result);\n                    console.log('then c: ', c);\n                    nightmare.goto('https://vk.com/search?c%5Bcity%5D=' + CitiesID[c] + '&c%5Bcountry%5D=1&c%5Bsection%5D=communities&c%5Bskip_catalog%5D=1&c%5Btype%5D=3')\n                    .wait(2000)\n                    .inject('js', './jquery_v1_10_2.js')\n                    .wait(2000)\n                    .scrollTo(999999999999999999999999999,0)\n                    .wait(5000)\n                    .evaluate(function () {\n                        var shortNames = [];\n                        $('.labeled.title a').each(function () {\n                            var item = $(this).attr('href');\n                            $.trim(item);\n                            item = item.replace('/','');\n                            item = item.replace('event','club');\n                            shortNames.push(item)\n                        });\n\n                        console.log('shortNames:', shortNames);\n\n                        mergeName = result.concat(shortNames);\n                        mergeName = arrayUnique(mergeName);\n\n                        var mergeResult = mergeName.join(',');\n                        if (mergeResult) {\n                            resolve(mergeResult);\n                        } else {\n                            reject('Ошибка при парсе данных с сайта');\n                        }\n\n                    })\n                })\n            },\n            function () {\n                console.error('Произошла ошибка в след. обещании после API request:');\n            })\n            .then(function (result) {\n                console.info('Результат после merge: ', result) //запись в базу данных с сайта\n            },\n            function (error) {\n                console.error(error);\n            })\n            .then(() => {\n                //console.log(c);\n                vk.api.groups.getById({\n                   group_ids: '137040892,145368412,121232062,140933197,139631659,100506804,135759889',\n                   fields: 'members_count,start_date,activity,place'\n                })\n                .then((data) => {\n                   console.log(data);\n                   var dataObj = JSON.stringify(data);\n                   var dataJSON = JSON.parse(dataObj);\n                   for (var i = 0; i < dataJSON.length; i++) {\n                       groupID.push(dataJSON[i].id);\n                       var place = dataJSON[i].place;\n                       if (place) {\n                           groupLatitude.push(dataJSON[i].place.latitude);\n                           groupLongitude.push(dataJSON[i].place.longitude);\n                       } else {\n                           groupLatitude.push('Адрес неизвестен');\n                           groupLongitude.push('Адрес неизвестен');\n                       }\n                       groupName.push(dataJSON[i].name);\n                       groupActivity.push(dataJSON[i].activity);\n                       groupPhoto.push(dataJSON[i].photo_200);\n                       groupStartdate.push(dataJSON[i].start_date);\n                   }\n                   console.log(groupPhoto);\n               })\n            })\n            .catch((error) => {\n                console.error(error);\n            });\n    };\n}\n\n\n\n// Get Groups ID\n\nauth.run()\n    .then((token) => {\n        console.log('User token:',token);\n        vk.setToken(token);\n        for (var c = 0; c<CitiesID.length; c++) { // цикл для сбора данных по всем городам\n            for (var j = 0; j<ABC.length; j++) { // цикл для сбора данных по всем поисковым словам\n                setTimeout(tryGetGroupData(j,c), 4000*(j+1)); // Groups.search\n            }\n        }\n    }, () => console.error('Ошибка при получении токена.'))\n    .catch((error) => {\n        console.error(error);\n    });\n\n\n/*setTimeout(function () {\n    db.get().collection('events').find({}, {name:1}).sort({_id:1}).forEach(function(doc) {\n        db.get().collection('events').remove({\n            _id:{$gt:doc._id},\n            name:doc.name\n        })\n    })\n}, 5000)*/\n\n\n//app.get(eventsController.deleteDouble);\n\n\n// API methods\n\napp.get('/', function (req, res) {\n    res.send(\"OneTwoMeet.ru started!\");\n});\n\napp.get('/events', eventsController.all);\n\napp.get('/events/:id', eventsController.findById);\n\napp.post('/events/:cityid', eventsController.create);\n\n//app.put('/events/:id', eventsController.update);\n\n//app.delete('/events/:id', eventsController.delete);\n\napp.delete('events/remove', eventsController.deleteDouble);\n\n\ndb.connect(\"mongodb://localhost:27017/VK_eAPI\", function (err) { // VK_eAPI or test\n    if(err) { return console.log(err); }\n    app.listen(1337, function () {\n        console.log(\"API app started\");\n    });\n});"]}