{"version":3,"sources":["refactorApp.js"],"names":[],"mappings":"AAAA,IAAI,UAAU,QAAQ,SAAR,CAAd;AACA,IAAI,aAAa,QAAQ,aAAR,CAAjB;AACA,IAAI,cAAc,QAAQ,SAAR,EAAmB,WAArC;AACA,IAAI,WAAW,QAAQ,SAAR,EAAmB,QAAlC;AACA,IAAI,KAAK,QAAQ,SAAR,CAAT;AACA,IAAI,mBAAmB,QAAQ,yBAAR,CAAvB;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;AACA,IAAI,UAAU,QAAQ,SAAR,CAAd;AACA,IAAI,UAAU,QAAQ,SAAR,CAAd;AACA,IAAI,KAAK,QAAQ,IAAR,CAAT;AACA,IAAI,WAAW,QAAQ,UAAR,CAAf;AACA,IAAI,MAAM,SAAV;AACA,MAAM,KAAK,QAAQ,OAAR,CAAX;AACA,MAAM,KAAK,IAAI,EAAJ,CAAO;AACd,SAAK,OADS;AAEd,WAAO,EAFO;AAGd,UAAM,EAHQ;AAId,WAAO,EAJO;AAKd,WAAO;AALO,CAAP,CAAX;AAOA,IAAI,SAAS,QAAQ,QAAR,CAAb;AACA,IAAI,YAAY,QAAQ,WAAR,CAAhB;AACA,YAAY,UAAU,EAAE,MAAM,IAAR,EAAc,MAAM,IAApB,EAAV,CAAZ;AACA;AACA,IAAI,UAAU,EAAd;AACA,IAAI,YAAY,EAAhB;AACA,IAAI,gBAAgB,EAApB;AACA,IAAI,eAAe,EAAnB;AACA,IAAI,aAAa,EAAjB;AACA,IAAI,iBAAgB,EAApB;AACA,IAAI,gBAAgB,EAApB;AACA,IAAI,iBAAiB,EAArB;;AAGA,IAAI,WAAW,CAAC,GAAD,CAAf;;AAGA,IAAI,GAAJ,CAAQ,WAAW,IAAX,EAAR;AACA,IAAI,GAAJ,CAAQ,WAAW,UAAX,CAAsB,EAAE,UAAU,IAAZ,EAAtB,CAAR;AACA,MAAM,OAAO,GAAG,IAAH,CAAQ,UAAR,EAAb;;AAGA,SAAS,WAAT,CAAqB,GAArB,EAAyB;AACrB,WAAO,IAAI,MAAJ,CAAW,CAAC,CAAD,EAAG,CAAH,EAAK,CAAL,KAAS,EAAE,OAAF,CAAU,CAAV,KAAc,CAAlC,CAAP;AACH;AACD,SAAS,YAAT,CAAsB,MAAtB,EAA8B,MAA9B,EAAsC;AAClC,WAAO,OAAO,KAAP,GAAe,OAAO,KAA7B;AACH;AACD,SAAS,oBAAT,GAAgC;AAC5B,YAAQ,MAAR,GAAiB,CAAjB;AACA,cAAU,MAAV,GAAmB,CAAnB;AACA,kBAAc,MAAd,GAAuB,CAAvB;AACA,iBAAa,MAAb,GAAsB,CAAtB;AACA,eAAW,MAAX,GAAoB,CAApB;AACA,mBAAe,MAAf,GAAwB,CAAxB;AACA,kBAAc,MAAd,GAAuB,CAAvB;AACA,mBAAe,MAAf,GAAwB,CAAxB;AACH;;AAED,SAAS,aAAT,CAAuB,MAAvB,EAA+B,CAA/B,EAAkC;AAC9B,WAAO,YAAY;AACf;AACA,WAAG,GAAH,CAAO,MAAP,CAAc,OAAd,CAAsB;AACd,uBAAW,MADG;AAEd,oBAAQ;AAFM,SAAtB,EAIK,IAJL,CAIW,IAAD,IAAU;AACZ;;AAEA;;AAEA,gBAAI,UAAU,KAAK,SAAL,CAAe,IAAf,CAAd;AACA,gBAAI,WAAW,KAAK,KAAL,CAAW,OAAX,CAAf;;AAEA,iBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,SAAS,MAA7B,EAAqC,GAArC,EAA0C;;AAEtC,wBAAQ,IAAR,CAAa,SAAS,CAAT,EAAY,EAAzB;AACA,0BAAU,IAAV,CAAe,SAAS,CAAT,EAAY,IAA3B;AACA,2BAAW,IAAX,CAAgB,SAAS,CAAT,EAAY,SAA5B;;AAEA,oBAAI,QAAQ,SAAS,CAAT,EAAY,KAAxB;AACA,oBAAI,KAAJ,EAAW;AACP,kCAAc,IAAd,CAAmB,SAAS,CAAT,EAAY,KAAZ,CAAkB,QAArC;AACA,mCAAe,IAAf,CAAoB,SAAS,CAAT,EAAY,KAAZ,CAAkB,SAAtC;AACH,iBAHD,MAGO;AACH,4BAAQ,IAAR,CAAa,uDAAb;AACA,kCAAc,IAAd,CAAmB,CAAnB;AACA,mCAAe,IAAf,CAAoB,CAApB;AACH;;AAED,oBAAI,SAAS,CAAT,EAAY,SAAZ,IAAyB,CAA7B,EAAgC;AAC5B,kCAAc,IAAd,CAAmB,SAAS,CAAT,EAAY,QAA/B;AACA,iCAAa,IAAb,CAAkB,SAAS,CAAT,EAAY,aAA9B;AACA,mCAAe,IAAf,CAAoB,SAAS,CAAT,EAAY,UAAhC;AACH,iBAJD,MAIO;AACH,4BAAQ,IAAR,CAAa,oBAAb;AACA,kCAAc,IAAd,CAAmB,mBAAnB;AACA,iCAAa,IAAb,CAAkB,CAAlB;AACA,mCAAe,IAAf,CAAoB,UAApB;AACH;AAEJ;AAEJ,SAzCL,EA0CK,IA1CL,CA0CU,MAAM;;AAER,iBAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,QAAQ,MAA5B,EAAoC,GAApC,EAAyC;AACrC,wBAAQ,IAAR,CAAa;AACT,yBAAK,kCAAkC,SAAS,CAAT,CAD9B;AAET,0BAAM;AACF,4BAAI,QAAQ,CAAR,CADF;AAEF,8BAAM,UAAU,CAAV,CAFJ;AAGF,kCAAU,cAAc,CAAd,CAHR;AAIF,+BAAO,WAAW,CAAX,CAJL;AAKF,+BAAO,eAAe,CAAf,CALL;AAMF,iCAAS,aAAa,CAAb,CANP;AAOF,kCAAU,cAAc,CAAd,CAPR;AAQF,mCAAW,eAAe,CAAf;AART;AAFG,iBAAb,EAYG,UAAU,GAAV,EAAe,GAAf,EAAoB,IAApB,EAA0B;AACzB,wBAAI,GAAJ,EAAS;AACL,gCAAQ,GAAR,CAAY,GAAZ;AACH,qBAFD,MAEO,IAAI,IAAJ,EAAU;AACb;AACH;AACJ,iBAlBD;AAmBH;AAGJ,SAnEL;AAoEH,KAtED;AAuEH;;AAED,SAAS,iBAAT,CAA2B,CAA3B,EAA8B;AAC1B,WAAO,YAAY;AACf,kBAAU,IAAV,CAAe,uCAAuC,SAAS,CAAT,CAAvC,GAAqD,kFAApE,EACK,IADL,CACU,IADV,EAEK,MAFL,CAEY,IAFZ,EAEkB,qBAFlB,EAGK,IAHL,CAGU,IAHV,EAIK,MAJL,CAIY,IAJZ,EAIkB,oBAJlB,EAKK,IALL,CAKU,KALV,EAMK,QANL,CAMc,YAAY;AAClB,gBAAI,aAAa,EAAjB;AACA,cAAE,kBAAF,EAAsB,IAAtB,CAA2B,YAAY;AACnC,oBAAI,OAAO,EAAE,IAAF,EAAQ,IAAR,CAAa,MAAb,CAAX;AACA,kBAAE,IAAF,CAAO,IAAP;AACA,uBAAO,KAAK,OAAL,CAAa,GAAb,EAAiB,EAAjB,CAAP;AACA,uBAAO,KAAK,OAAL,CAAa,OAAb,EAAqB,MAArB,CAAP;AACA,2BAAW,IAAX,CAAgB,IAAhB;AACH,aAND;;AAQA;;AAEA;;AAEA,mBAAO,UAAP;AACH,SArBL,EAsBK,IAtBL,CAsBU,UAAU,MAAV,EAAkB;AACpB,oBAAQ,IAAR,CAAa,gBAAb,EAA+B,CAA/B;AACA,gBAAI,YAAY,MAAhB;AACA,oBAAQ,IAAR,CAAa,UAAU,MAAvB;AACA,iBAAI,IAAI,IAAI,CAAZ,EAAe,KAAK,UAAU,MAA9B,EAAsC,IAAI,IAAE,GAA5C,EAAiD;;AAE7C,oBAAI,SAAS,UAAU,KAAV,CAAgB,CAAhB,EAAmB,IAAE,GAArB,CAAb;AACA,yBAAS,OAAO,IAAP,CAAY,GAAZ,CAAT;AACA,wBAAQ,IAAR,CAAa,gBAAb,EAA+B,CAA/B;AACA,2BAAW,cAAc,MAAd,EAAsB,CAAtB,CAAX,EAAqC,QAAM,IAAE,CAAR,CAArC;AACH;AACJ,SAjCL,EAkCK,KAlCL,CAkCY,KAAD,IAAW;AACd,oBAAQ,KAAR,CAAc,KAAd;AACH,SApCL;AAqCH,KAtCD;AAuCH;;AAKD,SAAS,cAAT,GAA0B;;AAEtB;;AAEA,SAAK,IAAI,IAAI,CAAb,EAAgB,IAAE,SAAS,MAA3B,EAAmC,GAAnC,EAAwC;AAAE;AACtC;AACA,mBAAW,kBAAkB,CAAlB,CAAX,EAAiC,QAAM,IAAE,CAAR,CAAjC,EAFoC,CAEU;AACjD;AAEJ;;AAED;;AAMA;;AAEA,IAAI,GAAJ,CAAQ,GAAR,EAAa,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC7B,QAAI,IAAJ,CAAS,wBAAT;AACH,CAFD;;AAIA,IAAI,GAAJ,CAAQ,SAAR,EAAmB,iBAAiB,GAApC;;AAEA,IAAI,GAAJ,CAAQ,aAAR,EAAuB,iBAAiB,QAAxC;;AAEA,IAAI,IAAJ,CAAS,iBAAT,EAA4B,iBAAiB,MAA7C;;AAEA;;AAEA;;AAEA,IAAI,MAAJ,CAAW,eAAX,EAA4B,iBAAiB,YAA7C;;AAGA,GAAG,OAAH,CAAW,mCAAX,EAAgD,UAAU,GAAV,EAAe;AAAE;AAC7D,QAAG,GAAH,EAAQ;AAAE,eAAO,QAAQ,GAAR,CAAY,GAAZ,CAAP;AAA0B;AACpC,QAAI,MAAJ,CAAW,IAAX,EAAiB,YAAY;AACzB,gBAAQ,GAAR,CAAY,iBAAZ;AACH,KAFD;AAGH,CALD","file":"refactorApp-compiled.js","sourcesContent":["var express = require('express');\nvar bodyParser = require('body-parser');\nvar MongoClient = require('mongodb').MongoClient;\nvar ObjectID = require('mongodb').ObjectID;\nvar db = require('./../db');\nvar eventsController = require('./../controllers/events');\nvar path = require('path');\nvar request = require('request');\nvar cheerio = require('cheerio');\nvar fs = require('fs');\nvar encoding = require('encoding');\nvar app = express();\nconst VK = require('vk-io');\nconst vk = new VK({\n    app: 5980502,\n    login: '',\n    pass: '',\n    phone: '',\n    scope: 'stats,notifications,groups,wall,pages,friends,offline,photos,market'\n});\nvar jquery = require('jquery');\nvar Nightmare = require('nightmare');\nnightmare = Nightmare({ show: true, dock: true });\n//var ABC = [\"в\",\"с\",\"до\",\"от\",\"2017\",\"по\",\"на\",\"за\",\"для\",\"фестиваль\",\"день\",\"уроки\",\"встреча\",\"отдых\",\"МК\"];\nvar groupID = [];\nvar groupName = [];\nvar groupActivity = [];\nvar groupMembers = [];\nvar groupPhoto = [];\nvar groupStartdate= [];\nvar groupLatitude = [];\nvar groupLongitude = [];\n\n\nvar CitiesID = ['1'];\n\n\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\nconst auth = vk.auth.standalone();\n\n\nfunction arrayUnique(arr){\n    return arr.filter((e,i,a)=>a.indexOf(e)==i)\n}\nfunction compareStart(eventA, eventB) {\n    return eventA.start - eventB.start;\n}\nfunction cleaningGlobalValues() {\n    groupID.length = 0;\n    groupName.length = 0;\n    groupActivity.length = 0;\n    groupMembers.length = 0;\n    groupPhoto.length = 0;\n    groupStartdate.length = 0;\n    groupLatitude.length = 0;\n    groupLongitude.length = 0;\n}\n\nfunction groupsGetByID(arr400, c) {\n    return function () {\n        //console.info(arr400);\n        vk.api.groups.getById({\n                group_ids: arr400,\n                fields: 'members_count,start_date,activity,place'\n            })\n            .then((data) => {\n                //console.log(data);\n\n                cleaningGlobalValues();\n\n                var dataObj = JSON.stringify(data);\n                var dataJSON = JSON.parse(dataObj);\n\n                for (var i = 0; i < dataJSON.length; i++) {\n\n                    groupID.push(dataJSON[i].id);\n                    groupName.push(dataJSON[i].name);\n                    groupPhoto.push(dataJSON[i].photo_200);\n\n                    var place = dataJSON[i].place;\n                    if (place) {\n                        groupLatitude.push(dataJSON[i].place.latitude);\n                        groupLongitude.push(dataJSON[i].place.longitude);\n                    } else {\n                        console.info('Адрес проведения мероприятий не указан организаторами');\n                        groupLatitude.push(0);\n                        groupLongitude.push(0);\n                    }\n\n                    if (dataJSON[i].is_closed == 0) {\n                        groupActivity.push(dataJSON[i].activity);\n                        groupMembers.push(dataJSON[i].members_count);\n                        groupStartdate.push(dataJSON[i].start_date);\n                    } else {\n                        console.info('Частное сообщество');\n                        groupActivity.push(\"Данные недоступны\");\n                        groupMembers.push(0);\n                        groupStartdate.push(2001513200);\n                    }\n\n                }\n\n            })\n            .then(() => {\n\n                for (var i = 0; i < groupID.length; i++) {\n                    request.post({\n                        url: 'http://localhost:1337/events/' + CitiesID[c],\n                        form: {\n                            id: groupID[i],\n                            name: groupName[i],\n                            activity: groupActivity[i],\n                            photo: groupPhoto[i],\n                            start: groupStartdate[i],\n                            members: groupMembers[i],\n                            latitude: groupLatitude[i],\n                            longitude: groupLongitude[i]\n                        }\n                    }, function (err, res, body) {\n                        if (err) {\n                            console.log(err);\n                        } else if (body) {\n                            //console.log(body);\n                        }\n                    });\n                }\n\n\n            });\n    }\n}\n\nfunction parseDataFromSite(c) {\n    return function () {\n        nightmare.goto('https://vk.com/search?c%5Bcity%5D=' + CitiesID[c] + '&c%5Bcountry%5D=1&c%5Bsection%5D=communities&c%5Bskip_catalog%5D=1&c%5Btype%5D=3')\n            .wait(2000)\n            .inject('js', './jquery_v1_10_2.js')\n            .wait(3000)\n            .inject('js', './scrollAnimate.js')\n            .wait(15000)\n            .evaluate(function () {\n                var shortNames = [];\n                $('.labeled.title a').each(function () {\n                    var item = $(this).attr('href');\n                    $.trim(item);\n                    item = item.replace('/','');\n                    item = item.replace('event','club');\n                    shortNames.push(item)\n                });\n\n                //console.log('shortNames:', shortNames);\n\n                //shortNames = shortNames.join(',');\n\n                return shortNames;\n            })\n            .then(function (result) {\n                console.info('Параметр \"с\": ', c);\n                var eventsArr = result;\n                console.info(eventsArr.length);\n                for(var n = 0; n <= eventsArr.length; n = n+400) {\n\n                    var arr400 = eventsArr.slice(n, n+400);\n                    arr400 = arr400.join(',');\n                    console.info('Параметр \"с\": ', c);\n                    setTimeout(groupsGetByID(arr400, c), 1000*(n+1));\n                }\n            })\n            .catch((error) => {\n                console.error(error);\n            });\n    }\n}\n\n\n\n\nfunction StartRecording() {\n\n    cleaningGlobalValues();\n\n    for (var c = 0; c<CitiesID.length; c++) { // цикл для сбора данных по всем городам\n        cleaningGlobalValues();\n        setTimeout(parseDataFromSite(c), 6000*(c+1)); // Сбор, сортировка, запись\n    }\n\n}\n\nStartRecording();\n\n\n\n\n\n// API methods\n\napp.get('/', function (req, res) {\n    res.send(\"OneTwoMeet.ru started!\");\n});\n\napp.get('/events', eventsController.all);\n\napp.get('/events/:id', eventsController.findById);\n\napp.post('/events/:cityid', eventsController.create);\n\n//app.put('/events/:id', eventsController.update);\n\n//app.delete('/events/:id', eventsController.delete);\n\napp.delete('events/remove', eventsController.deleteDouble);\n\n\ndb.connect(\"mongodb://localhost:27017/VK_eAPI\", function (err) { // VK_eAPI or test\n    if(err) { return console.log(err); }\n    app.listen(1337, function () {\n        console.log(\"API app started\");\n    });\n});\n"]}