{"version":3,"sources":["asincNightmare.js"],"names":[],"mappings":"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","file":"asincNightmare-compiled.js","sourcesContent":["var express = require('express');\nvar bodyParser = require('body-parser');\nvar MongoClient = require('mongodb').MongoClient;\nvar ObjectID = require('mongodb').ObjectID;\nvar db = require('./../db');\n//var eventsController = require('./../controllers/events');\nvar path = require('path');\nvar request = require('request');\nvar cheerio = require('cheerio');\nvar fs = require('fs');\nvar app = express();\nconst VK = require('vk-io');\nconst vk = new VK({\n    app: 5980502,\n    login: 'ilia.fyodoroff@mail.ru',\n    pass: 'zxcfghb12QLNkftMGS44078',\n    phone: '+79220291925',\n    scope: 'stats,notifications,groups,wall,pages,friends,offline,photos,market'\n});\nvar jquery = require('jquery');\n\n\nvar groupID = [];\nvar groupName = [];\nvar groupActivity = [];\nvar groupMembers = [];\nvar groupPhoto = [];\nvar groupStartdate= [];\nvar groupLatitude = [];\nvar groupLongitude = [];\nvar eventsArr = [];\n\nvar CitiesID = ['96'];\nvar ABC = [\"в\", \"c\"];\n\n\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({ extended: true }));\nconst auth = vk.auth.standalone();\n\n\nfunction arrayUnique(arr){\n    return arr.filter((e,i,a)=>a.indexOf(e)==i)\n}\nfunction compareStart(eventA, eventB) {\n    return eventA.start - eventB.start;\n}\nfunction cleaningGlobalValues() {\n    groupID.length = 0;\n    groupName.length = 0;\n    groupActivity.length = 0;\n    groupMembers.length = 0;\n    groupPhoto.length = 0;\n    groupStartdate.length = 0;\n    groupLatitude.length = 0;\n    groupLongitude.length = 0;\n    eventsArr.length = 0;\n}\n\nfunction RemoveDoubleRequest(c) {\n    setTimeout(function () {\n        console.log('Запрос на удаление дублей в Mongodb');\n        db.get().collection('cityevents').find({\"cityid\":CitiesID[c]}, {id:1}).sort({_id:1}).forEach(function(doc) {\n            db.get().collection('cityevents').remove({\n                _id:{$gt:doc._id},\n                id: doc.id\n            })\n        });\n\n    }, 500)\n}\n\nvar Nightmare = require('nightmare');\nvar vo = require('vo');\nvar nightmare = Nightmare({ show: true, dock: true });\n\nvar email = 'ilia.fyodoroff@mail.ru';\nvar password = 'zxcfghb12QLNkftMGS44078';\n\n\n\nvar schedule = require('node-schedule');\nvar rule = new schedule.RecurrenceRule();\nrule.minute = new schedule.Range(0, 59, 3);\n\n\nfunction asyncNightmare() {\n\n    var urls = [\n        'https://vk.com/search?c%5Bcity%5D=96&c%5Bcountry%5D=1&c%5Bnot_safe%5D=1&c%5Bsection%5D=communities&c%5Btype%5D=3',\n        'https://vk.com/search?c%5Bcity%5D=49&c%5Bcountry%5D=1&c%5Bnot_safe%5D=1&c%5Bsection%5D=communities&c%5Btype%5D=3',\n        'https://vk.com/search?c%5Bcity%5D=153&c%5Bcountry%5D=1&c%5Bnot_safe%5D=1&c%5Bsection%5D=communities&c%5Btype%5D=3'\n    ];\n    urls.reduce(function(accumulator, url) {\n        return accumulator.then(function(results) {\n            return nightmare.goto(url)\n                .wait('body')\n                .wait(15000)\n                //.title()\n                .inject('js', './../jquery_v1_10_2.js')\n                .wait(1500)\n                .inject('js', './../scrollAnimate.js')\n                .wait(15000)\n                // .then(function(result){\n                //     results.push(result);\n                //     return results;\n                // });\n                .evaluate(function () {\n                    var shortNames = [];\n                    $('.labeled.title a').each(function () {\n                        var item = $(this).attr('href');\n                        $.trim(item);\n                        item = item.replace('/','');\n                        item = item.replace('event','club');\n                        shortNames.push(item)\n                    });\n\n                    shortNames = shortNames.join(',');\n\n                    return new Promise(function (resolve, reject) {\n                        setTimeout(() => resolve(shortNames), 1000);\n                    })\n                })\n                .then(function (result) {\n                    return new Promise(function (resolve, reject) {\n                        console.info('Result (nightmare по городу): ',result);\n                        vk.api.groups.getById({\n                                group_ids: result,\n                                fields: 'members_count,start_date,activity,place'\n                            })\n                            .then((data) => {\n                                //console.log(data);\n\n                                var id = [];\n                                var name = [];\n                                var activity = [];\n                                var photo = [];\n                                var start = [];\n                                var members = [];\n                                var latitude = [];\n                                var longitude = [];\n\n                                var gLatitude = 0;\n                                var gLongitude = 0;\n                                var gMembers = 0;\n                                var gActivity = \"Данные недоступны\";\n                                var gStartDate = 2001513200;\n\n\n                                var dataObj = JSON.stringify(data);\n                                var dataJSON = JSON.parse(dataObj);\n\n                                for (var i = 0; i < dataJSON.length; i++) {\n\n                                    var place = dataJSON[i].place;\n                                    if (place) {\n                                        gLatitude = dataJSON[i].place.latitude;\n                                        gLongitude = dataJSON[i].place.longitude;\n                                    } else {\n                                        //console.info('Адрес проведения мероприятий не указан организаторами');\n                                    }\n\n                                    if (dataJSON[i].is_closed == 0) {\n                                        gActivity = dataJSON[i].activity;\n                                        gMembers = dataJSON[i].members_count;\n                                        gStartDate = dataJSON[i].start_date;\n                                    } else {\n                                        console.info('Частное сообщество');\n                                    }\n\n                                    if ((gMembers == 0) || (gMembers == 1)) {\n                                        //console.log(\"Число участников: \", gMembers);\n                                        //console.log(\"Аватар сообщества: \", dataJSON[i].photo_200);\n                                        //console.log('ПУСТОЕ СООБЩЕСТВО');\n                                    } else {\n                                        id.push(dataJSON[i].id);\n                                        name.push(dataJSON[i].name);\n                                        activity.push(gActivity);\n                                        photo.push(dataJSON[i].photo_200);\n                                        start.push(gStartDate);\n                                        members.push(gMembers);\n                                        latitude.push(gLatitude);\n                                        longitude.push(gLongitude);\n                                    }\n\n\n                                }\n\n                                for (var l=0; l<id.length; l++) {\n                                    //console.log('XXXXXXX----XXXXXX', l);\n                                    request.post({\n                                        url: 'http://localhost:1337/events/'+CitiesID[c],\n                                        form: {\n                                            id: id[l],\n                                            name: name[l],\n                                            activity: activity[l],\n                                            photo: photo[l],\n                                            start: start[l],\n                                            members: members[l],\n                                            latitude: latitude[l],\n                                            longitude: longitude[l]\n                                        }\n                                    }, function (err, res, body) {\n                                        if (err) {\n                                            console.log(err);\n                                        } else if (body) {\n                                            console.log(body);\n                                        }\n                                    });\n\n                                    if (l == id.length-1) {\n                                        resolve();\n                                        console.log('DICK');\n                                        //RemoveDoubleRequest();\n                                    }\n                                }\n\n                                //resolve(eventsArr);\n                            })\n                            .then(() => {\n                                console.log('DICK2');\n                                console.log('Параметр \"с\" перед удалением дублей: ', c);\n                                RemoveDoubleRequest(c);\n                            })\n                    })\n                })\n                .catch((error) => {\n                    console.error(error);\n                    // if (error.statusCode == 404) {\n                    //     parseDataFromSite(c);\n                    // }\n                })\n        });\n    }, Promise.resolve([])).then(function(results){\n        console.dir(results);\n    });\n}\n\n\nfunction login() {\n    nightmare\n        .goto('https://vk.com/login')\n        .wait(1000)\n        .type('form [name=email]', email)\n        .click('input#pass')\n        .type('input#pass', password)\n        .click('button#login_button')\n        .wait(4000);\n}\n\n\n\nschedule.scheduleJob(rule, function(){\n    asyncNightmare();\n});\n\n\n\n\n\n\n\n\n\n\ndb.connect(\"mongodb://localhost:27017/VK_eAPI\", function (err) { // VK_eAPI or test\n    if(err) { return console.log(err); }\n    app.listen(1337, function () {\n        console.log(\"API app started\");\n    });\n});"]}